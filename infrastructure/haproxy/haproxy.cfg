# HAProxy Configuration for E2E Encrypted Messaging App
# Handles load balancing for chat servers with WebSocket support

global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048
    ssl-default-bind-options ssl-min-ver TLSv1.3 no-tls-tickets

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    timeout tunnel  1h

# Stats page (for monitoring)
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats admin if LOCALHOST
    # Prometheus metrics - use haproxy's built-in exporter
    http-request use-service prometheus-exporter if { path /metrics }

# HTTP to HTTPS redirect
frontend http_front
    bind *:80
    http-request set-header X-Forwarded-Proto http

    # Redirect all HTTP traffic to HTTPS
    redirect scheme https code 301 if !{ ssl_fc }

# HTTPS Frontend (production)
frontend https_front
    bind *:443 ssl crt /etc/ssl/certs/haproxy.pem
    http-request set-header X-Forwarded-Proto https

    # Security headers
    http-response set-header X-Frame-Options DENY
    http-response set-header X-Content-Type-Options nosniff
    http-response set-header X-XSS-Protection "1; mode=block"
    http-response set-header Referrer-Policy strict-origin-when-cross-origin
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header Cross-Origin-Embedder-Policy require-corp
    http-response set-header Cross-Origin-Opener-Policy same-origin
    http-response set-header Cross-Origin-Resource-Policy same-origin
    http-response set-header Permissions-Policy "camera=(), microphone=(), geolocation=(), payment=(), usb=()"
    http-response set-header Expect-CT "max-age=86400, enforce, report-uri='https://silentrelay.com.au/ct-report'"
    http-response set-header Report-To "{\"group\":\"csp-endpoint\",\"max_age\":10886400,\"endpoints\":[{\"url\":\"https://silentrelay.com.au/csp-report\"}],\"include_subdomains\":true}"

    # ACL for WebSocket upgrade
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_websocket hdr_beg(Host) -i ws

    # ACL for API paths
    acl is_api path_beg /api
    acl is_auth path_beg /auth
    acl is_ws_path path_beg /ws
    acl is_health path /health

    # Route WebSocket to sticky backend
    use_backend websocket_backend if is_websocket
    use_backend websocket_backend if is_ws_path

    # Route API requests
    use_backend api_backend if is_api
    use_backend api_backend if is_auth
    use_backend api_backend if is_health

    # Default to frontend (React app)
    default_backend frontend_backend


# Backend for WebSocket connections (sticky sessions)
backend websocket_backend
    mode http
    balance source
    option httpchk GET /health
    http-check expect status 200

    # Forward client IP
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Proto https

    option forwardfor

    # Long timeout for WebSocket connections
    timeout tunnel 3600s
    timeout server 3600s
    timeout client 3600s

    server chat-server-1 chat-server-1:8080 check inter 5s fall 3 rise 2 resolvers docker init-addr none
    server chat-server-2 chat-server-2:8080 check inter 5s fall 3 rise 2 resolvers docker init-addr none

# Backend for REST API (round-robin)
backend api_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200

    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Proto https

    server chat-server-1 chat-server-1:8080 check inter 5s fall 3 rise 2 resolvers docker init-addr none
    server chat-server-2 chat-server-2:8080 check inter 5s fall 3 rise 2 resolvers docker init-addr none

# Backend for Frontend (React app)
backend frontend_backend
    mode http
    balance roundrobin
    server frontend frontend:80 check resolvers docker init-addr none

# Docker DNS resolver
resolvers docker
    nameserver dns1 127.0.0.11:53
    resolve_retries 3
    timeout resolve 1s
    timeout retry 1s
    hold valid 10s
