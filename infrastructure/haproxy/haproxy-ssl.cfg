# HAProxy Configuration with SSL - Enhanced Security Version
# Use this after running setup-ssl.sh

global
    log stdout format raw local0
    maxconn 4096
    tune.ssl.default-dh-param 2048
    ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.3 no-tls-tickets no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12
    ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11 no-tlsv12
    ssl-dh-param-file /etc/ssl/certs/dh-param.pem

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  forwardfor
    timeout connect 5s
    timeout client  60s
    timeout server  60s
    timeout tunnel  1h

# Stats and metrics
frontend stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    # Prometheus metrics - use haproxy's built-in exporter
    http-request use-service prometheus-exporter if { path /metrics }

# HTTPS Frontend
frontend https_front
    bind *:443 ssl crt /etc/ssl/certs/server.pem alpn h2,http/1.1
    
    # Security headers
    http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    http-response set-header X-Frame-Options "DENY"
    http-response set-header X-Content-Type-Options "nosniff"
    
    # Health check
    acl is_health path /health
    
    # WebSocket detection
    acl is_websocket hdr(Upgrade) -i websocket
    acl is_ws_path path_beg /ws
    
    # API paths
    acl is_api path_beg /api
    
    # SSL/TLS Security Enhancements
    # Enable OCSP stapling for better performance and security
    http-request set-var(req.tls_version) ssl_fc_protocol
    http-request set-var(req.cipher) ssl_fc_cipher

    # Log TLS information for monitoring
    http-request capture req.hdr(User-Agent) len 128
    http-request capture req.hdr(Host) len 64

    # Security monitoring - log weak connections
    http-request deny if is_weak_cipher !{ ssl_fc_protocol -i TLSv1.3 }

    # Routing
    use_backend websocket_backend if is_websocket
    use_backend websocket_backend if is_ws_path
    use_backend api_backend if is_api
    use_backend api_backend if is_health

    # Default to frontend (React app)
    default_backend frontend_backend

# WebSocket backend (sticky)
backend websocket_backend
    mode http
    balance source
    option httpchk GET /health
    http-check expect status 200
    
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Proto https
    
    timeout tunnel 1h
    
    server chat-server-1 chat-server-1:8080 check
    server chat-server-2 chat-server-2:8080 check

# API backend (round-robin)
backend api_backend
    mode http
    balance roundrobin
    option httpchk GET /health
    http-check expect status 200
    
    http-request set-header X-Forwarded-For %[src]
    http-request set-header X-Real-IP %[src]
    http-request set-header X-Forwarded-Proto https
    
    server chat-server-1 chat-server-1:8080 check
    server chat-server-2 chat-server-2:8080 check

# Frontend backend (React app)
backend frontend_backend
    mode http
    server frontend frontend:443 check

