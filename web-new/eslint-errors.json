[{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\e2e-tests.spec.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\eslint.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\load_test.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\localStorage-encryption-e2e.spec.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\postcss.config.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\public\\olm.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\App.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ErrorBoundary.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":237,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":237,"endColumn":32},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":250,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":250,"endColumn":34}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * Comprehensive Error Boundary Component\r\n *\r\n * Provides graceful error handling with:\r\n * - Fallback UI for different error types\r\n * - Error reporting and logging\r\n * - Recovery options\r\n * - Development vs production modes\r\n */\r\n\r\nimport React, { Component, ErrorInfo, ReactNode } from 'react';\r\nimport { AlertTriangle, RefreshCw, Home, Bug } from 'lucide-react';\r\nimport { Button } from './ui/button';\r\n\r\ninterface Props {\r\n  children: ReactNode;\r\n  fallback?: ReactNode;\r\n  onError?: (error: Error, errorInfo: ErrorInfo) => void;\r\n  showReportButton?: boolean;\r\n}\r\n\r\ninterface State {\r\n  hasError: boolean;\r\n  error: Error | null;\r\n  errorInfo: ErrorInfo | null;\r\n  errorId: string | null;\r\n}\r\n\r\nexport class ErrorBoundary extends Component<Props, State> {\r\n  constructor(props: Props) {\r\n    super(props);\r\n    this.state = {\r\n      hasError: false,\r\n      error: null,\r\n      errorInfo: null,\r\n      errorId: null,\r\n    };\r\n  }\r\n\r\n  static getDerivedStateFromError(error: Error): Partial<State> {\r\n    return {\r\n      hasError: true,\r\n      error,\r\n      errorId: `error-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\r\n    };\r\n  }\r\n\r\n  componentDidCatch(error: Error, errorInfo: ErrorInfo) {\r\n    this.setState({\r\n      error,\r\n      errorInfo,\r\n    });\r\n\r\n    // Log error\r\n    console.error('ErrorBoundary caught an error:', error, errorInfo);\r\n\r\n    // Call custom error handler if provided\r\n    if (this.props.onError) {\r\n      this.props.onError(error, errorInfo);\r\n    }\r\n\r\n    // Report to error tracking service (if available)\r\n    this.reportError(error, errorInfo);\r\n  }\r\n\r\n  private reportError = (error: Error, errorInfo: ErrorInfo) => {\r\n    // In a real app, you would send this to Sentry, LogRocket, etc.\r\n    const errorReport = {\r\n      message: error.message,\r\n      stack: error.stack,\r\n      componentStack: errorInfo.componentStack,\r\n      timestamp: new Date().toISOString(),\r\n      userAgent: navigator.userAgent,\r\n      url: window.location.href,\r\n      errorId: this.state.errorId,\r\n    };\r\n\r\n    // For now, just log to console in development\r\n    if (process.env.NODE_ENV === 'development') {\r\n      console.error('Error Report:', errorReport);\r\n    }\r\n\r\n    // TODO: Send to error tracking service\r\n    // errorTrackingService.report(errorReport);\r\n  };\r\n\r\n  private handleRetry = () => {\r\n    this.setState({\r\n      hasError: false,\r\n      error: null,\r\n      errorInfo: null,\r\n      errorId: null,\r\n    });\r\n  };\r\n\r\n  private handleReload = () => {\r\n    window.location.reload();\r\n  };\r\n\r\n  private handleGoHome = () => {\r\n    window.location.href = '/';\r\n  };\r\n\r\n  private handleReportBug = () => {\r\n    const errorId = this.state.errorId;\r\n    const subject = `Bug Report: Application Error ${errorId}`;\r\n    const body = `Error ID: ${errorId}\\n\\nPlease describe what you were doing when this error occurred:\\n\\n`;\r\n\r\n    // Open email client or bug reporting system\r\n    window.open(`mailto:support@silentrelay.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`);\r\n  };\r\n\r\n  render() {\r\n    if (this.state.hasError) {\r\n      // Custom fallback UI\r\n      if (this.props.fallback) {\r\n        return this.props.fallback;\r\n      }\r\n\r\n      // Default error UI\r\n      return <ErrorFallback\r\n        error={this.state.error}\r\n        errorId={this.state.errorId}\r\n        onRetry={this.handleRetry}\r\n        onReload={this.handleReload}\r\n        onGoHome={this.handleGoHome}\r\n        onReportBug={this.props.showReportButton ? this.handleReportBug : undefined}\r\n      />;\r\n    }\r\n\r\n    return this.props.children;\r\n  }\r\n}\r\n\r\n/**\r\n * Error Fallback UI Component\r\n */\r\ninterface ErrorFallbackProps {\r\n  error: Error | null;\r\n  errorId: string | null;\r\n  onRetry?: () => void;\r\n  onReload?: () => void;\r\n  onGoHome?: () => void;\r\n  onReportBug?: () => void;\r\n}\r\n\r\nfunction ErrorFallback({\r\n  error,\r\n  errorId,\r\n  onRetry,\r\n  onReload,\r\n  onGoHome,\r\n  onReportBug,\r\n}: ErrorFallbackProps) {\r\n  const isDevelopment = process.env.NODE_ENV === 'development';\r\n\r\n  return (\r\n    <div className=\"min-h-screen flex items-center justify-center p-4 bg-background\">\r\n      <div className=\"max-w-md w-full space-y-6 text-center\">\r\n        {/* Error Icon */}\r\n        <div className=\"w-16 h-16 rounded-full bg-destructive/10 flex items-center justify-center mx-auto\">\r\n          <AlertTriangle className=\"h-8 w-8 text-destructive\" />\r\n        </div>\r\n\r\n        {/* Error Title */}\r\n        <div>\r\n          <h1 className=\"text-2xl font-bold text-foreground mb-2\">\r\n            Something went wrong\r\n          </h1>\r\n          <p className=\"text-muted-foreground\">\r\n            We encountered an unexpected error. Please try again or contact support if the problem persists.\r\n          </p>\r\n        </div>\r\n\r\n        {/* Error Details (Development Only) */}\r\n        {isDevelopment && error && (\r\n          <div className=\"bg-muted p-4 rounded-lg text-left\">\r\n            <h3 className=\"font-semibold text-sm mb-2\">Error Details:</h3>\r\n            <p className=\"text-sm font-mono text-destructive break-all\">\r\n              {error.message}\r\n            </p>\r\n            {errorId && (\r\n              <p className=\"text-xs text-muted-foreground mt-2\">\r\n                Error ID: {errorId}\r\n              </p>\r\n            )}\r\n          </div>\r\n        )}\r\n\r\n        {/* Action Buttons */}\r\n        <div className=\"flex flex-col gap-3\">\r\n          {onRetry && (\r\n            <Button onClick={onRetry} className=\"w-full\">\r\n              <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n              Try Again\r\n            </Button>\r\n          )}\r\n\r\n          <div className=\"flex gap-2\">\r\n            {onReload && (\r\n              <Button variant=\"outline\" onClick={onReload} className=\"flex-1\">\r\n                <RefreshCw className=\"h-4 w-4 mr-2\" />\r\n                Reload Page\r\n              </Button>\r\n            )}\r\n\r\n            {onGoHome && (\r\n              <Button variant=\"outline\" onClick={onGoHome} className=\"flex-1\">\r\n                <Home className=\"h-4 w-4 mr-2\" />\r\n                Go Home\r\n              </Button>\r\n            )}\r\n          </div>\r\n\r\n          {onReportBug && (\r\n            <Button variant=\"ghost\" onClick={onReportBug} className=\"w-full\">\r\n              <Bug className=\"h-4 w-4 mr-2\" />\r\n              Report Bug\r\n            </Button>\r\n          )}\r\n        </div>\r\n\r\n        {/* Support Information */}\r\n        <div className=\"text-xs text-muted-foreground\">\r\n          <p>\r\n            If this error persists, please contact our support team with the error details above.\r\n          </p>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * Hook for handling async errors in functional components\r\n */\r\nexport function useErrorHandler() {\r\n  return (error: Error, errorInfo?: { componentStack?: string }) => {\r\n    // Log the error\r\n    console.error('Async error caught:', error, errorInfo);\r\n\r\n    // In a real app, you might want to show a toast notification\r\n    // or send to error tracking service\r\n  };\r\n}\r\n\r\n/**\r\n * Higher-order component for adding error boundaries\r\n */\r\nexport function withErrorBoundary<P extends object>(\r\n  Component: React.ComponentType<P>,\r\n  errorBoundaryProps?: Omit<Props, 'children'>\r\n) {\r\n  const WrappedComponent = (props: P) => (\r\n    <ErrorBoundary {...errorBoundaryProps}>\r\n      <Component {...props} />\r\n    </ErrorBoundary>\r\n  );\r\n\r\n  WrappedComponent.displayName = `withErrorBoundary(${Component.displayName || Component.name})`;\r\n\r\n  return WrappedComponent;\r\n}\r\n\r\nexport default ErrorBoundary;","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\Onboarding.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\call\\CallScreen.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\call\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\ChatHeader.tsx","messages":[{"ruleId":"no-constant-binary-expression","severity":2,"message":"Unexpected constant truthiness on the left-hand side of a `&&` expression.","line":157,"column":11,"nodeType":"LogicalExpression","messageId":"constantShortCircuit","endLine":157,"endColumn":28}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * ChatHeader Component\r\n *\r\n * Adaptive chat header with:\r\n * - Compact mobile design (56-64px height)\r\n * - Back navigation button on mobile\r\n * - Contact avatar and name\r\n * - Online status / typing indicator\r\n * - Action buttons (call, video, more)\r\n */\r\n\r\nimport { memo, useMemo } from 'react';\r\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\r\nimport { Button } from '@/components/ui/button';\r\nimport {\r\n  ChevronLeft,\r\n  Phone,\r\n  Video,\r\n  MoreVertical,\r\n  Shield,\r\n} from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\nimport { useIsMobile } from '@/hooks/useViewport';\r\n\r\ninterface ChatHeaderProps {\r\n  /** Recipient name */\r\n  recipientName: string;\r\n  /** Recipient avatar URL */\r\n  recipientAvatar?: string;\r\n  /** Whether recipient is online */\r\n  isOnline: boolean;\r\n  /** Last seen timestamp */\r\n  lastSeen?: number;\r\n  /** Whether recipient is typing */\r\n  isTyping?: boolean;\r\n  /** Whether this is an encrypted conversation */\r\n  isEncrypted?: boolean;\r\n  /** Callback for back button (mobile only) */\r\n  onBack?: () => void;\r\n  /** Callback for voice call */\r\n  onVoiceCall?: () => void;\r\n  /** Callback for video call */\r\n  onVideoCall?: () => void;\r\n  /** Callback for more options menu */\r\n  onMoreOptions?: () => void;\r\n  /** Additional className */\r\n  className?: string;\r\n}\r\n\r\nexport const ChatHeader = memo(function ChatHeader({\r\n  recipientName,\r\n  recipientAvatar,\r\n  isOnline,\r\n  lastSeen,\r\n  isTyping,\r\n  isEncrypted = true,\r\n  onBack,\r\n  onVoiceCall,\r\n  onVideoCall,\r\n  onMoreOptions,\r\n  className,\r\n}: ChatHeaderProps) {\r\n  const isMobile = useIsMobile();\r\n\r\n  // Format status text\r\n  const statusText = useMemo(() => {\r\n    if (isTyping) return 'typing...';\r\n    if (isOnline) return 'online';\r\n    if (lastSeen) return `last seen ${formatLastSeen(lastSeen)}`;\r\n    return 'offline';\r\n  }, [isTyping, isOnline, lastSeen]);\r\n\r\n  // Get initials for avatar\r\n  const initials = useMemo(() => {\r\n    const name = recipientName.replace(/^@/, '');\r\n    return name.charAt(0).toUpperCase();\r\n  }, [recipientName]);\r\n\r\n  return (\r\n    <header\r\n      className={cn(\r\n        // Base styles\r\n        'flex items-center justify-between',\r\n        'border-b border-border bg-background-secondary',\r\n        // Mobile: compact height with safe area\r\n        isMobile ? 'h-14 px-2 pt-safe' : 'h-16 px-4',\r\n        className\r\n      )}\r\n    >\r\n      {/* Left section: back button + avatar + info */}\r\n      <div className=\"flex items-center gap-2 min-w-0 flex-1\">\r\n        {/* Back button (mobile only) */}\r\n        {isMobile && onBack && (\r\n          <Button\r\n            variant=\"ghost\"\r\n            size=\"icon\"\r\n            className=\"touch-target flex-shrink-0 -ml-2\"\r\n            onClick={onBack}\r\n            aria-label=\"Go back to conversations\"\r\n          >\r\n            <ChevronLeft className=\"h-6 w-6\" />\r\n          </Button>\r\n        )}\r\n\r\n        {/* Avatar */}\r\n        <div className=\"relative flex-shrink-0\">\r\n          <Avatar className={isMobile ? 'h-9 w-9' : 'h-10 w-10'}>\r\n            <AvatarImage src={recipientAvatar} alt=\"\" />\r\n            <AvatarFallback className=\"bg-background-tertiary text-foreground-secondary\">\r\n              {initials}\r\n            </AvatarFallback>\r\n          </Avatar>\r\n          {isOnline && (\r\n            <span\r\n              className={cn(\r\n                'absolute bottom-0 right-0 rounded-full bg-success border-2 border-background-secondary',\r\n                isMobile ? 'w-2.5 h-2.5' : 'w-3 h-3'\r\n              )}\r\n              aria-label=\"Online\"\r\n            />\r\n          )}\r\n        </div>\r\n\r\n        {/* Name and status */}\r\n        <div className=\"min-w-0 flex-1\">\r\n          <div className=\"flex items-center gap-1.5\">\r\n            <h2\r\n              className={cn(\r\n                'font-semibold truncate',\r\n                isMobile ? 'text-sm' : 'text-base'\r\n              )}\r\n            >\r\n              {recipientName}\r\n            </h2>\r\n            {isEncrypted && (\r\n              <Shield\r\n                className=\"h-3.5 w-3.5 text-primary flex-shrink-0\"\r\n                aria-label=\"End-to-end encrypted\"\r\n              />\r\n            )}\r\n          </div>\r\n          <p\r\n            className={cn(\r\n              'text-foreground-muted truncate',\r\n              isMobile ? 'text-xs' : 'text-sm',\r\n              isTyping && 'text-primary'\r\n            )}\r\n          >\r\n            {statusText}\r\n          </p>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Right section: action buttons */}\r\n      <div className=\"flex items-center flex-shrink-0\">\r\n        {/* Show all buttons on desktop, collapse to 2 on mobile */}\r\n        {(!isMobile || true) && (\r\n          <>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"touch-target\"\r\n              onClick={onVoiceCall}\r\n              aria-label=\"Voice call\"\r\n            >\r\n              <Phone className={isMobile ? 'h-5 w-5' : 'h-4 w-4'} />\r\n            </Button>\r\n            <Button\r\n              variant=\"ghost\"\r\n              size=\"icon\"\r\n              className=\"touch-target\"\r\n              onClick={onVideoCall}\r\n              aria-label=\"Video call\"\r\n            >\r\n              <Video className={isMobile ? 'h-5 w-5' : 'h-4 w-4'} />\r\n            </Button>\r\n          </>\r\n        )}\r\n        <Button\r\n          variant=\"ghost\"\r\n          size=\"icon\"\r\n          className=\"touch-target\"\r\n          onClick={onMoreOptions}\r\n          aria-label=\"More options\"\r\n        >\r\n          <MoreVertical className={isMobile ? 'h-5 w-5' : 'h-4 w-4'} />\r\n        </Button>\r\n      </div>\r\n    </header>\r\n  );\r\n});\r\n\r\n/**\r\n * Format last seen timestamp\r\n */\r\nfunction formatLastSeen(timestamp: number): string {\r\n  const now = Date.now();\r\n  const diff = now - timestamp;\r\n  const minutes = Math.floor(diff / 60000);\r\n  const hours = Math.floor(diff / 3600000);\r\n  const days = Math.floor(diff / 86400000);\r\n\r\n  if (minutes < 1) return 'just now';\r\n  if (minutes < 60) return `${minutes}m ago`;\r\n  if (hours < 24) return `${hours}h ago`;\r\n  if (days < 7) return `${days}d ago`;\r\n  \r\n  return new Date(timestamp).toLocaleDateString(undefined, {\r\n    month: 'short',\r\n    day: 'numeric',\r\n  });\r\n}\r\n\r\n/**\r\n * Skeleton loading state for chat header\r\n */\r\nexport function ChatHeaderSkeleton({ isMobile }: { isMobile?: boolean }) {\r\n  return (\r\n    <div\r\n      className={cn(\r\n        'flex items-center gap-3 border-b border-border bg-background-secondary',\r\n        isMobile ? 'h-14 px-2 pt-safe' : 'h-16 px-4'\r\n      )}\r\n    >\r\n      {isMobile && <div className=\"skeleton h-10 w-10 rounded-lg\" />}\r\n      <div className=\"skeleton h-10 w-10 rounded-full\" />\r\n      <div className=\"flex-1 space-y-2\">\r\n        <div className=\"skeleton h-4 w-32 rounded\" />\r\n        <div className=\"skeleton h-3 w-16 rounded\" />\r\n      </div>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\ConversationItem.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\ConversationList.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\FileUpload.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\MessageBubble.tsx","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_showActions' is assigned a value but never used.","line":95,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":95,"endColumn":22}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * MessageBubble Component\r\n *\r\n * Touch-optimized message bubble with:\r\n * - Swipe-to-reply gesture\r\n * - Swipe-to-delete/archive gesture\r\n * - Read receipts indicators\r\n * - Timestamp display\r\n * - File message handling\r\n * - Skeleton loading state\r\n */\r\n\r\nimport { memo, useMemo, useState, useRef, useCallback } from 'react';\r\nimport { Check, CheckCheck, Reply, Trash2, Download, Loader2 } from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\nimport { useSwipeGesture } from '@/hooks/useSwipeGesture';\r\nimport type { Message } from '@/core/types';\r\nimport { sanitizeMessageContent, isSafeThumbnailUrl } from '@/core/utils/sanitization';\r\n\r\ninterface MessageBubbleProps {\r\n  /** Message data */\r\n  message: Message;\r\n  /** Whether this is the current user's message */\r\n  isOwn: boolean;\r\n  /** Callback when reply is triggered */\r\n  onReply?: (message: Message) => void;\r\n  /** Callback when delete is triggered */\r\n  onDelete?: (message: Message) => void;\r\n  /** Callback for file download */\r\n  onFileDownload?: (metadata: FileMetadata) => void;\r\n  /** Whether file is currently downloading */\r\n  isDownloading?: boolean;\r\n  /** Additional className */\r\n  className?: string;\r\n}\r\n\r\ninterface FileMetadata {\r\n  fileName: string;\r\n  fileSize: number;\r\n  mimeType: string;\r\n  mediaId: string;\r\n  thumbnail?: string;\r\n  encryptionKey: number[];\r\n  iv: number[];\r\n}\r\n\r\n// Check if content is a file message\r\nfunction isFileMessage(content: string): boolean {\r\n  return content.startsWith('[FILE:') && content.endsWith(']');\r\n}\r\n\r\n// Parse file message content\r\nfunction parseFileMessage(content: string): FileMetadata | null {\r\n  try {\r\n    const jsonStr = content.slice(6, -1);\r\n    return JSON.parse(jsonStr);\r\n  } catch {\r\n    return null;\r\n  }\r\n}\r\n\r\n// Format timestamp\r\nfunction formatMessageTime(timestamp: number): string {\r\n  return new Date(timestamp).toLocaleTimeString([], {\r\n    hour: '2-digit',\r\n    minute: '2-digit',\r\n  });\r\n}\r\n\r\n// Format file size\r\nfunction formatFileSize(bytes: number): string {\r\n  if (bytes < 1024) return `${bytes} B`;\r\n  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;\r\n  return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;\r\n}\r\n\r\n// Get file icon based on mime type\r\nfunction getFileIcon(mimeType: string): string {\r\n  if (mimeType.startsWith('image/')) return '≡ƒû╝∩╕Å';\r\n  if (mimeType.startsWith('audio/')) return '≡ƒÄ╡';\r\n  if (mimeType.startsWith('video/')) return '≡ƒÄ¼';\r\n  if (mimeType === 'application/pdf') return '≡ƒôä';\r\n  return '≡ƒôÄ';\r\n}\r\n\r\nexport const MessageBubble = memo(function MessageBubble({\r\n  message,\r\n  isOwn,\r\n  onReply,\r\n  onDelete,\r\n  onFileDownload,\r\n  isDownloading,\r\n  className,\r\n}: MessageBubbleProps) {\r\n  const [_showActions, setShowActions] = useState(false);\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Parse file metadata if this is a file message\r\n  const fileMetadata = useMemo(() => {\r\n    if (isFileMessage(message.content)) {\r\n      return parseFileMessage(message.content);\r\n    }\r\n    return null;\r\n  }, [message.content]);\r\n\r\n  // Swipe gesture for reply (swipe right) and delete (swipe left)\r\n  const { swipeState, handlers } = useSwipeGesture({\r\n    horizontal: true,\r\n    vertical: false,\r\n    threshold: 60,\r\n    maxDistance: 80,\r\n    onSwipeRight: () => {\r\n      if (onReply) {\r\n        onReply(message);\r\n      }\r\n    },\r\n    onSwipeLeft: () => {\r\n      if (isOwn && onDelete) {\r\n        setShowActions(true);\r\n      }\r\n    },\r\n    onSwipeEnd: () => {\r\n      // Reset after a delay\r\n      setTimeout(() => setShowActions(false), 2000);\r\n    },\r\n  });\r\n\r\n  // Handle file download\r\n  const handleDownload = useCallback(() => {\r\n    if (fileMetadata && onFileDownload) {\r\n      onFileDownload(fileMetadata);\r\n    }\r\n  }, [fileMetadata, onFileDownload]);\r\n\r\n  // Get status icon\r\n  const StatusIcon = useMemo(() => {\r\n    switch (message.status) {\r\n      case 'sending':\r\n        return (\r\n          <span className=\"w-3 h-3 rounded-full border border-current border-t-transparent animate-spin inline-block\" />\r\n        );\r\n      case 'sent':\r\n        return <Check className=\"h-3.5 w-3.5\" />;\r\n      case 'delivered':\r\n        return <CheckCheck className=\"h-3.5 w-3.5\" />;\r\n      case 'read':\r\n        return <CheckCheck className=\"h-3.5 w-3.5 text-primary\" />;\r\n      case 'failed':\r\n        return <span className=\"text-destructive text-xs\">!</span>;\r\n      default:\r\n        return null;\r\n    }\r\n  }, [message.status]);\r\n\r\n  // Calculate swipe transform\r\n  const swipeTransform = useMemo(() => {\r\n    if (swipeState.isSwiping) {\r\n      // Limit the visual offset\r\n      const offset = Math.min(Math.abs(swipeState.offsetX), 60) * Math.sign(swipeState.offsetX);\r\n      return `translateX(${offset}px)`;\r\n    }\r\n    return 'translateX(0)';\r\n  }, [swipeState]);\r\n\r\n  return (\r\n    <div\r\n      ref={containerRef}\r\n      className={cn(\r\n        'swipeable-message relative',\r\n        isOwn ? 'flex justify-end' : 'flex justify-start',\r\n        className\r\n      )}\r\n      {...handlers}\r\n    >\r\n      {/* Reply indicator (shown on swipe right) */}\r\n      {swipeState.direction === 'right' && (\r\n        <div\r\n          className={cn(\r\n            'absolute left-0 top-1/2 -translate-y-1/2 flex items-center justify-center',\r\n            'w-10 h-10 rounded-full bg-background-tertiary',\r\n            'transition-opacity duration-150',\r\n            swipeState.offsetX > 30 ? 'opacity-100' : 'opacity-50'\r\n          )}\r\n        >\r\n          <Reply className=\"h-5 w-5 text-foreground-muted\" />\r\n        </div>\r\n      )}\r\n\r\n      {/* Delete indicator (shown on swipe left for own messages) */}\r\n      {swipeState.direction === 'left' && isOwn && (\r\n        <div\r\n          className={cn(\r\n            'absolute right-0 top-1/2 -translate-y-1/2 flex items-center justify-center',\r\n            'w-10 h-10 rounded-full bg-destructive/20',\r\n            'transition-opacity duration-150',\r\n            Math.abs(swipeState.offsetX) > 30 ? 'opacity-100' : 'opacity-50'\r\n          )}\r\n        >\r\n          <Trash2 className=\"h-5 w-5 text-destructive\" />\r\n        </div>\r\n      )}\r\n\r\n      {/* Message bubble */}\r\n      <div\r\n        className=\"transition-transform duration-150 ease-out\"\r\n        style={{ transform: swipeTransform }}\r\n      >\r\n        {fileMetadata ? (\r\n          // File message\r\n          <FileMessageContent\r\n            metadata={fileMetadata}\r\n            isOwn={isOwn}\r\n            onDownload={handleDownload}\r\n            isDownloading={isDownloading}\r\n            timestamp={message.timestamp}\r\n            statusIcon={StatusIcon}\r\n          />\r\n        ) : (\r\n          // Text message\r\n          <div\r\n            className={cn(\r\n              'max-w-[280px] sm:max-w-[320px] md:max-w-[400px]',\r\n              'rounded-2xl px-4 py-2',\r\n              isOwn\r\n                ? 'bg-message-outgoing text-white rounded-br-md'\r\n                : 'bg-message-incoming text-foreground rounded-bl-md'\r\n            )}\r\n          >\r\n            <p className=\"text-sm whitespace-pre-wrap break-words\">\r\n              {sanitizeMessageContent(message.content)}\r\n            </p>\r\n            <div\r\n              className={cn(\r\n                'flex items-center gap-1 mt-1',\r\n                isOwn ? 'justify-end' : 'justify-start'\r\n              )}\r\n            >\r\n              <span className=\"text-2xs opacity-70\">\r\n                {formatMessageTime(message.timestamp)}\r\n              </span>\r\n              {isOwn && (\r\n                <span className=\"opacity-70\">{StatusIcon}</span>\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n});\r\n\r\n/**\r\n * File message content component\r\n */\r\nfunction FileMessageContent({\r\n  metadata,\r\n  isOwn,\r\n  onDownload,\r\n  isDownloading,\r\n  timestamp,\r\n  statusIcon,\r\n}: {\r\n  metadata: FileMetadata;\r\n  isOwn: boolean;\r\n  onDownload: () => void;\r\n  isDownloading?: boolean;\r\n  timestamp: number;\r\n  statusIcon: React.ReactNode;\r\n}) {\r\n  const isImage = metadata.mimeType.startsWith('image/');\r\n\r\n  return (\r\n    <div className=\"space-y-1\">\r\n      <button\r\n        onClick={onDownload}\r\n        disabled={isDownloading}\r\n        className={cn(\r\n          'block rounded-xl overflow-hidden border border-border/50',\r\n          'min-w-[200px] max-w-[280px]',\r\n          'transition-transform active:scale-[0.98]',\r\n          isOwn ? 'bg-message-outgoing/80' : 'bg-message-incoming'\r\n        )}\r\n      >\r\n        {/* Thumbnail preview for images */}\r\n        {isImage && metadata.thumbnail && isSafeThumbnailUrl(metadata.thumbnail) && (\r\n          <div className=\"aspect-video bg-background-tertiary relative\">\r\n            <img\r\n              src={metadata.thumbnail}\r\n              alt=\"\"\r\n              className=\"w-full h-full object-cover\"\r\n            />\r\n            <div className=\"absolute inset-0 flex items-center justify-center bg-black/30\">\r\n              {isDownloading ? (\r\n                <Loader2 className=\"h-8 w-8 text-white animate-spin\" />\r\n              ) : (\r\n                <Download className=\"h-8 w-8 text-white\" />\r\n              )}\r\n            </div>\r\n          </div>\r\n        )}\r\n\r\n        {/* File info */}\r\n        <div className=\"flex items-center gap-3 p-3\">\r\n          <span className=\"text-2xl\">{getFileIcon(metadata.mimeType)}</span>\r\n          <div className=\"flex-1 min-w-0 text-left\">\r\n            <p\r\n              className={cn(\r\n                'text-sm font-medium truncate',\r\n                isOwn ? 'text-white' : 'text-foreground'\r\n              )}\r\n            >\r\n              {sanitizeMessageContent(metadata.fileName)}\r\n            </p>\r\n            <p\r\n              className={cn(\r\n                'text-xs',\r\n                isOwn ? 'text-white/70' : 'text-foreground-muted'\r\n              )}\r\n            >\r\n              {formatFileSize(metadata.fileSize)}\r\n              {isDownloading && ' ΓÇó Downloading...'}\r\n            </p>\r\n          </div>\r\n          {!isImage && (\r\n            <div className=\"flex-shrink-0\">\r\n              {isDownloading ? (\r\n                <Loader2 className={cn('h-5 w-5 animate-spin', isOwn ? 'text-white/70' : 'text-foreground-muted')} />\r\n              ) : (\r\n                <Download className={cn('h-5 w-5', isOwn ? 'text-white/70' : 'text-foreground-muted')} />\r\n              )}\r\n            </div>\r\n          )}\r\n        </div>\r\n      </button>\r\n\r\n      {/* Timestamp and status */}\r\n      <div\r\n        className={cn(\r\n          'flex items-center gap-1 px-1',\r\n          isOwn ? 'justify-end' : 'justify-start'\r\n        )}\r\n      >\r\n        <span className=\"text-2xs text-foreground-muted\">\r\n          {formatMessageTime(timestamp)}\r\n        </span>\r\n        {isOwn && (\r\n          <span className=\"text-foreground-muted\">{statusIcon}</span>\r\n        )}\r\n      </div>\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * Skeleton loading state for message bubble\r\n */\r\nexport function MessageBubbleSkeleton({ isOwn }: { isOwn: boolean }) {\r\n  return (\r\n    <div className={cn('flex', isOwn ? 'justify-end' : 'justify-start')}>\r\n      <div\r\n        className={cn(\r\n          'skeleton rounded-2xl',\r\n          isOwn\r\n            ? 'bg-message-outgoing/30 rounded-br-md'\r\n            : 'bg-background-tertiary rounded-bl-md'\r\n        )}\r\n        style={{\r\n          width: `${Math.random() * 100 + 120}px`,\r\n          height: '40px',\r\n        }}\r\n      />\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * Date separator component\r\n */\r\nexport function DateSeparator({ date }: { date: Date }) {\r\n  const text = useMemo(() => {\r\n    const today = new Date();\r\n    const yesterday = new Date(today);\r\n    yesterday.setDate(yesterday.getDate() - 1);\r\n\r\n    if (date.toDateString() === today.toDateString()) {\r\n      return 'Today';\r\n    }\r\n    if (date.toDateString() === yesterday.toDateString()) {\r\n      return 'Yesterday';\r\n    }\r\n    return date.toLocaleDateString(undefined, {\r\n      weekday: 'long',\r\n      month: 'long',\r\n      day: 'numeric',\r\n    });\r\n  }, [date]);\r\n\r\n  return (\r\n    <div className=\"flex items-center justify-center py-4\">\r\n      <span className=\"text-xs text-foreground-muted bg-background-secondary px-3 py-1 rounded-full\">\r\n        {text}\r\n      </span>\r\n    </div>\r\n  );\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\MessageInput.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\MessageList.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":208,"column":17,"nodeType":"Identifier","messageId":"namedExport","endLine":208,"endColumn":35}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * MessageList Component\r\n *\r\n * Message list with:\r\n * - Automatic scroll to bottom on new messages\r\n * - Scroll preservation on older messages load\r\n * - Date separators\r\n * - Empty state with encryption notice\r\n * - Loading skeletons\r\n */\r\n\r\nimport { useRef, useEffect, useCallback, useMemo } from 'react';\r\nimport { ScrollArea } from '@/components/ui/scroll-area';\r\nimport { Shield } from 'lucide-react';\r\nimport { cn } from '@/lib/utils';\r\nimport { MessageBubble, MessageBubbleSkeleton, DateSeparator } from './MessageBubble';\r\nimport type { Message, FileMetadata } from '@/core/types';\r\n\r\ninterface MessageListProps {\r\n  /** List of messages */\r\n  messages: Message[];\r\n  /** Current user ID */\r\n  currentUserId: string;\r\n  /** Whether messages are loading */\r\n  isLoading?: boolean;\r\n  /** Callback when reply is triggered on a message */\r\n  onReply?: (message: Message) => void;\r\n  /** Callback when delete is triggered on a message */\r\n  onDelete?: (message: Message) => void;\r\n  /** Callback for file download - accepts FileMetadata from MessageBubble */\r\n  onFileDownload?: (metadata: FileMetadata) => void;\r\n  /** Set of currently downloading file IDs */\r\n  downloadingFiles?: Set<string>;\r\n  /** Additional className */\r\n  className?: string;\r\n}\r\n\r\nexport function MessageList({\r\n  messages,\r\n  currentUserId,\r\n  isLoading,\r\n  onReply,\r\n  onDelete,\r\n  onFileDownload,\r\n  downloadingFiles = new Set(),\r\n  className,\r\n}: MessageListProps) {\r\n  const scrollRef = useRef<HTMLDivElement>(null);\r\n  const bottomRef = useRef<HTMLDivElement>(null);\r\n  const prevMessageCountRef = useRef(messages.length);\r\n\r\n  // Group messages by date\r\n  const groupedMessages = useMemo(() => {\r\n    const groups: Array<{ date: Date; messages: Message[] }> = [];\r\n    let currentDate: string | null = null;\r\n    let currentGroup: Message[] = [];\r\n\r\n    messages.forEach((message) => {\r\n      const messageDate = new Date(message.timestamp).toDateString();\r\n\r\n      if (messageDate !== currentDate) {\r\n        if (currentGroup.length > 0 && currentDate) {\r\n          groups.push({\r\n            date: new Date(currentDate),\r\n            messages: currentGroup,\r\n          });\r\n        }\r\n        currentDate = messageDate;\r\n        currentGroup = [message];\r\n      } else {\r\n        currentGroup.push(message);\r\n      }\r\n    });\r\n\r\n    // Add the last group\r\n    if (currentGroup.length > 0 && currentDate) {\r\n      groups.push({\r\n        date: new Date(currentDate),\r\n        messages: currentGroup,\r\n      });\r\n    }\r\n\r\n    return groups;\r\n  }, [messages]);\r\n\r\n  // Scroll to bottom on new messages\r\n  useEffect(() => {\r\n    const newMessageCount = messages.length;\r\n    const prevCount = prevMessageCountRef.current;\r\n\r\n    if (newMessageCount > prevCount) {\r\n      const scrollContainer = scrollRef.current;\r\n      if (scrollContainer) {\r\n        const isNearBottom =\r\n          scrollContainer.scrollHeight - scrollContainer.scrollTop - scrollContainer.clientHeight < 100;\r\n\r\n        if (isNearBottom || newMessageCount === prevCount + 1) {\r\n          bottomRef.current?.scrollIntoView({ behavior: 'smooth' });\r\n        }\r\n      }\r\n    }\r\n\r\n    prevMessageCountRef.current = newMessageCount;\r\n  }, [messages.length]);\r\n\r\n  // Initial scroll to bottom\r\n  useEffect(() => {\r\n    if (messages.length > 0 && !isLoading) {\r\n      bottomRef.current?.scrollIntoView();\r\n    }\r\n  }, [isLoading, messages.length]);\r\n\r\n  // Check if a file is downloading\r\n  const isFileDownloading = useCallback(\r\n    (content: string) => {\r\n      if (!content.startsWith('[FILE:')) return false;\r\n      try {\r\n        const metadata = JSON.parse(content.slice(6, -1));\r\n        return downloadingFiles.has(metadata.mediaId);\r\n      } catch {\r\n        return false;\r\n      }\r\n    },\r\n    [downloadingFiles]\r\n  );\r\n\r\n  if (isLoading) {\r\n    return (\r\n      <ScrollArea className={cn('flex-1 p-4', className)}>\r\n        <div className=\"space-y-4\">\r\n          {[...Array(8)].map((_, i) => (\r\n            <MessageBubbleSkeleton key={i} isOwn={i % 3 === 0} />\r\n          ))}\r\n        </div>\r\n      </ScrollArea>\r\n    );\r\n  }\r\n\r\n  if (messages.length === 0) {\r\n    return (\r\n      <div className={cn('flex-1 flex items-center justify-center p-8', className)}>\r\n        <EmptyState />\r\n      </div>\r\n    );\r\n  }\r\n\r\n  return (\r\n    <ScrollArea className={cn('flex-1', className)} ref={scrollRef}>\r\n      <div className=\"p-4 space-y-4\">\r\n        {groupedMessages.map((group) => (\r\n          <div key={group.date.toISOString()}>\r\n            <DateSeparator date={group.date} />\r\n            <div className=\"space-y-1 mt-2\">\r\n              {group.messages.map((message, idx) => {\r\n                const isOwn = message.senderId === currentUserId;\r\n                const isDownloading = isFileDownloading(message.content);\r\n                const prevMessage = idx > 0 ? group.messages[idx - 1] : null;\r\n                const showSpacing = !prevMessage || prevMessage.senderId !== message.senderId;\r\n\r\n                return (\r\n                  <div\r\n                    key={message.id}\r\n                    id={`message-${message.id}`}\r\n                    className={cn(showSpacing && idx > 0 ? 'pt-2' : '')}\r\n                  >\r\n                    <MessageBubble\r\n                      message={message}\r\n                      isOwn={isOwn}\r\n                      onReply={onReply}\r\n                      onDelete={isOwn ? onDelete : undefined}\r\n                      onFileDownload={onFileDownload}\r\n                      isDownloading={isDownloading}\r\n                    />\r\n                  </div>\r\n                );\r\n              })}\r\n            </div>\r\n          </div>\r\n        ))}\r\n        <div ref={bottomRef} />\r\n      </div>\r\n    </ScrollArea>\r\n  );\r\n}\r\n\r\n/**\r\n * Empty state with encryption notice\r\n */\r\nfunction EmptyState() {\r\n  return (\r\n    <div className=\"text-center max-w-xs mx-auto\">\r\n      <div className=\"w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mx-auto mb-4\">\r\n        <Shield className=\"h-8 w-8 text-primary\" />\r\n      </div>\r\n      <p className=\"text-foreground-secondary font-medium\">\r\n        Messages are end-to-end encrypted\r\n      </p>\r\n      <p className=\"text-sm text-foreground-muted mt-2\">\r\n        No one outside of this chat, not even SilentRelay, can read or listen to them.\r\n      </p>\r\n    </div>\r\n  );\r\n}\r\n\r\n/**\r\n * Hook to scroll to replied message\r\n */\r\nexport function useScrollToMessage() {\r\n  const containerRef = useRef<HTMLDivElement>(null);\r\n\r\n  const scrollToMessage = useCallback((messageId: string) => {\r\n    const element = document.getElementById(`message-${messageId}`);\r\n    if (element && containerRef.current) {\r\n      element.scrollIntoView({ behavior: 'smooth', block: 'center' });\r\n      // Highlight the message briefly\r\n      element.classList.add('bg-primary/10');\r\n      setTimeout(() => {\r\n        element.classList.remove('bg-primary/10');\r\n      }, 2000);\r\n    }\r\n  }, []);\r\n\r\n  return { containerRef, scrollToMessage };\r\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\chat\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\error\\ErrorDisplay.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\error\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\settings\\Settings.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\settings\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ui\\avatar.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ui\\button.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":58,"column":18,"nodeType":"Identifier","messageId":"namedExport","endLine":58,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from 'react';\nimport { Slot } from '@radix-ui/react-slot';\nimport { cva, type VariantProps } from 'class-variance-authority';\nimport { cn } from '@/lib/utils';\n\nconst buttonVariants = cva(\n  'inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0',\n  {\n    variants: {\n      variant: {\n        default:\n          'bg-primary text-primary-foreground hover:bg-primary-hover shadow-sm',\n        destructive:\n          'bg-destructive text-destructive-foreground hover:bg-destructive/90 shadow-sm',\n        outline:\n          'border border-border bg-transparent hover:bg-background-tertiary hover:text-foreground',\n        secondary:\n          'bg-background-tertiary text-foreground hover:bg-background-secondary shadow-sm',\n        ghost:\n          'hover:bg-background-tertiary hover:text-foreground',\n        link:\n          'text-primary underline-offset-4 hover:underline',\n      },\n      size: {\n        default: 'h-10 px-4 py-2',\n        sm: 'h-9 rounded-md px-3',\n        lg: 'h-11 rounded-md px-8',\n        icon: 'h-10 w-10',\n      },\n    },\n    defaultVariants: {\n      variant: 'default',\n      size: 'default',\n    },\n  }\n);\n\nexport interface ButtonProps\n  extends React.ButtonHTMLAttributes<HTMLButtonElement>,\n    VariantProps<typeof buttonVariants> {\n  asChild?: boolean;\n}\n\nconst Button = React.forwardRef<HTMLButtonElement, ButtonProps>(\n  ({ className, variant, size, asChild = false, ...props }, ref) => {\n    const Comp = asChild ? Slot : 'button';\n    return (\n      <Comp\n        className={cn(buttonVariants({ variant, size, className }))}\n        ref={ref}\n        {...props}\n      />\n    );\n  }\n);\nButton.displayName = 'Button';\n\nexport { Button, buttonVariants };\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ui\\dialog.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ui\\dropdown-menu.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ui\\input.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ui\\scroll-area.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\components\\ui\\toaster.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":197,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":197,"endColumn":11},{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":198,"column":3,"nodeType":"Identifier","messageId":"namedExport","endLine":198,"endColumn":8}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import * as React from 'react';\nimport * as ToastPrimitives from '@radix-ui/react-toast';\nimport { cva, type VariantProps } from 'class-variance-authority';\nimport { X } from 'lucide-react';\nimport { cn } from '@/lib/utils';\n\nconst ToastProvider = ToastPrimitives.Provider;\n\nconst ToastViewport = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Viewport>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Viewport>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Viewport\n    ref={ref}\n    className={cn(\n      'fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]',\n      className\n    )}\n    {...props}\n  />\n));\nToastViewport.displayName = ToastPrimitives.Viewport.displayName;\n\nconst toastVariants = cva(\n  'group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-x-0 data-[swipe=end]:translate-x-[var(--radix-toast-swipe-end-x)] data-[swipe=move]:translate-x-[var(--radix-toast-swipe-move-x)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-right-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full',\n  {\n    variants: {\n      variant: {\n        default: 'border-border bg-background-secondary text-foreground',\n        destructive:\n          'destructive group border-destructive bg-destructive text-destructive-foreground',\n        success:\n          'border-success bg-success/10 text-success',\n      },\n    },\n    defaultVariants: {\n      variant: 'default',\n    },\n  }\n);\n\nconst Toast = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Root>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Root> &\n    VariantProps<typeof toastVariants>\n>(({ className, variant, ...props }, ref) => {\n  return (\n    <ToastPrimitives.Root\n      ref={ref}\n      className={cn(toastVariants({ variant }), className)}\n      {...props}\n    />\n  );\n});\nToast.displayName = ToastPrimitives.Root.displayName;\n\nconst ToastAction = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Action>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Action>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Action\n    ref={ref}\n    className={cn(\n      'inline-flex h-8 shrink-0 items-center justify-center rounded-md border border-border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors hover:bg-background-tertiary focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none disabled:opacity-50',\n      className\n    )}\n    {...props}\n  />\n));\nToastAction.displayName = ToastPrimitives.Action.displayName;\n\nconst ToastClose = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Close>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Close>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Close\n    ref={ref}\n    className={cn(\n      'absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity hover:text-foreground focus:opacity-100 focus:outline-none focus:ring-2 group-hover:opacity-100',\n      className\n    )}\n    toast-close=\"\"\n    {...props}\n  >\n    <X className=\"h-4 w-4\" />\n  </ToastPrimitives.Close>\n));\nToastClose.displayName = ToastPrimitives.Close.displayName;\n\nconst ToastTitle = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Title>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Title>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Title\n    ref={ref}\n    className={cn('text-sm font-semibold', className)}\n    {...props}\n  />\n));\nToastTitle.displayName = ToastPrimitives.Title.displayName;\n\nconst ToastDescription = React.forwardRef<\n  React.ElementRef<typeof ToastPrimitives.Description>,\n  React.ComponentPropsWithoutRef<typeof ToastPrimitives.Description>\n>(({ className, ...props }, ref) => (\n  <ToastPrimitives.Description\n    ref={ref}\n    className={cn('text-sm opacity-90', className)}\n    {...props}\n  />\n));\nToastDescription.displayName = ToastPrimitives.Description.displayName;\n\n// Toast hook and Toaster component\ntype ToastProps = React.ComponentPropsWithoutRef<typeof Toast>;\ntype ToastActionElement = React.ReactElement<typeof ToastAction>;\n\ninterface ToastState {\n  id: string;\n  title?: React.ReactNode;\n  description?: React.ReactNode;\n  action?: ToastActionElement;\n  variant?: ToastProps['variant'];\n}\n\nconst toastState: { toasts: ToastState[]; listeners: Set<() => void> } = {\n  toasts: [],\n  listeners: new Set(),\n};\n\nfunction toast({\n  title,\n  description,\n  action,\n  variant,\n}: Omit<ToastState, 'id'>) {\n  const id = crypto.randomUUID();\n  toastState.toasts = [...toastState.toasts, { id, title, description, action, variant }];\n  toastState.listeners.forEach((listener) => listener());\n\n  setTimeout(() => {\n    toastState.toasts = toastState.toasts.filter((t) => t.id !== id);\n    toastState.listeners.forEach((listener) => listener());\n  }, 5000);\n\n  return id;\n}\n\nfunction useToast() {\n  const [, setUpdate] = React.useState(0);\n\n  React.useEffect(() => {\n    const listener = () => setUpdate((n) => n + 1);\n    toastState.listeners.add(listener);\n    return () => {\n      toastState.listeners.delete(listener);\n    };\n  }, []);\n\n  return {\n    toasts: toastState.toasts,\n    toast,\n  };\n}\n\nfunction Toaster() {\n  const { toasts } = useToast();\n\n  return (\n    <ToastProvider>\n      {toasts.map(({ id, title, description, action, variant }) => (\n        <Toast key={id} variant={variant}>\n          <div className=\"grid gap-1\">\n            {title && <ToastTitle>{title}</ToastTitle>}\n            {description && <ToastDescription>{description}</ToastDescription>}\n          </div>\n          {action}\n          <ToastClose />\n        </Toast>\n      ))}\n      <ToastViewport />\n    </ToastProvider>\n  );\n}\n\nexport {\n  type ToastProps,\n  type ToastActionElement,\n  ToastProvider,\n  ToastViewport,\n  Toast,\n  ToastTitle,\n  ToastDescription,\n  ToastClose,\n  ToastAction,\n  Toaster,\n  useToast,\n  toast,\n};\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\api\\client.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\media.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\protocolAdapter.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":182,"column":19,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":182,"endColumn":22,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5664,5667],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5664,5667],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Protocol Adapter Layer - Bridges Matrix Olm (frontend) with Signal Protocol (backend)\n *\n * This adapter resolves the protocol implementation mismatch between:\n * - Frontend: Matrix Olm library (Curve25519, Double Ratchet, specific message formats)\n * - Backend: Signal Protocol implementation (X25519, HKDF, different message structures)\n *\n * Key Responsibilities:\n * 1. Convert between Olm and Signal key formats\n * 2. Adapt message structures for compatibility\n * 3. Handle protocol flow differences\n * 4. Maintain security properties across both implementations\n */\n\nimport { signalProtocol, type KeyPair, type SignedPreKey, type PreKey, type EncryptedMessage } from './signal';\n\n// Backend API types (Signal Protocol format)\ninterface BackendKeyPair {\n  privateKey: string; // Base64 encoded 32-byte X25519 private key\n  publicKey: string;  // Base64 encoded 32-byte X25519 public key\n}\n\ninterface BackendSignedPreKey {\n  keyId: number;\n  publicKey: string;  // Base64 encoded 32-byte X25519 public key\n  privateKey: string; // Base64 encoded 32-byte X25519 private key\n  signature: string;  // Base64 encoded signature\n  timestamp: number;\n}\n\ninterface BackendPreKey {\n  keyId: number;\n  publicKey: string;  // Base64 encoded 32-byte X25519 public key\n  privateKey: string; // Base64 encoded 32-byte X25519 private key\n}\n\ninterface BackendEncryptedMessage {\n  ciphertext: string; // Base64 encoded ciphertext\n  messageType: 'prekey' | 'whisper';\n}\n\ninterface BackendPreKeyBundle {\n  registrationId: number;\n  deviceId: number;\n  identityKey: string;      // Base64 encoded 32-byte X25519 public key\n  signedPreKey: string;     // Base64 encoded 32-byte X25519 public key\n  signedPreKeyId: number;\n  signedPreKeySignature: string; // Base64 encoded signature\n  preKeyId?: number;\n  preKey?: string;          // Base64 encoded 32-byte X25519 public key\n}\n\n// Utility functions for base64 conversion\nfunction base64ToUint8Array(base64: string): Uint8Array {\n  const binary = atob(base64);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return bytes;\n}\n\nfunction uint8ArrayToBase64(bytes: Uint8Array): string {\n  let binary = '';\n  for (let i = 0; i < bytes.length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary);\n}\n\n\n/**\n * ProtocolAdapter class - Bridges Olm and Signal Protocol implementations\n */\nexport class ProtocolAdapter {\n  private olmProtocol: typeof signalProtocol;\n\n  constructor() {\n    this.olmProtocol = signalProtocol;\n  }\n\n  /**\n   * Convert Olm KeyPair to Backend KeyPair format\n   */\n  convertKeyPairToBackend(olmKeyPair: KeyPair): BackendKeyPair {\n    return {\n      privateKey: uint8ArrayToBase64(olmKeyPair.privateKey),\n      publicKey: uint8ArrayToBase64(olmKeyPair.publicKey),\n    };\n  }\n\n  /**\n   * Convert Backend KeyPair to Olm KeyPair format\n   */\n  convertKeyPairFromBackend(backendKeyPair: BackendKeyPair): KeyPair {\n    return {\n      privateKey: base64ToUint8Array(backendKeyPair.privateKey),\n      publicKey: base64ToUint8Array(backendKeyPair.publicKey),\n    };\n  }\n\n  /**\n   * Convert Olm SignedPreKey to Backend SignedPreKey format\n   */\n  convertSignedPreKeyToBackend(olmSignedPreKey: SignedPreKey): BackendSignedPreKey {\n    return {\n      keyId: olmSignedPreKey.keyId,\n      publicKey: uint8ArrayToBase64(olmSignedPreKey.publicKey),\n      privateKey: uint8ArrayToBase64(olmSignedPreKey.privateKey),\n      signature: uint8ArrayToBase64(olmSignedPreKey.signature),\n      timestamp: olmSignedPreKey.timestamp,\n    };\n  }\n\n  /**\n   * Convert Backend SignedPreKey to Olm SignedPreKey format\n   */\n  convertSignedPreKeyFromBackend(backendSignedPreKey: BackendSignedPreKey): SignedPreKey {\n    return {\n      keyId: backendSignedPreKey.keyId,\n      publicKey: base64ToUint8Array(backendSignedPreKey.publicKey),\n      privateKey: base64ToUint8Array(backendSignedPreKey.privateKey),\n      signature: base64ToUint8Array(backendSignedPreKey.signature),\n      timestamp: backendSignedPreKey.timestamp,\n    };\n  }\n\n  /**\n   * Convert Olm PreKey to Backend PreKey format\n   */\n  convertPreKeyToBackend(olmPreKey: PreKey): BackendPreKey {\n    return {\n      keyId: olmPreKey.keyId,\n      publicKey: uint8ArrayToBase64(olmPreKey.publicKey),\n      privateKey: uint8ArrayToBase64(olmPreKey.privateKey),\n    };\n  }\n\n  /**\n   * Convert Backend PreKey to Olm PreKey format\n   */\n  convertPreKeyFromBackend(backendPreKey: BackendPreKey): PreKey {\n    return {\n      keyId: backendPreKey.keyId,\n      publicKey: base64ToUint8Array(backendPreKey.publicKey),\n      privateKey: base64ToUint8Array(backendPreKey.privateKey),\n    };\n  }\n\n  /**\n   * Convert Olm EncryptedMessage to Backend EncryptedMessage format\n   */\n  convertEncryptedMessageToBackend(olmMessage: EncryptedMessage): BackendEncryptedMessage {\n    return {\n      ciphertext: uint8ArrayToBase64(olmMessage.ciphertext),\n      messageType: olmMessage.messageType,\n    };\n  }\n\n  /**\n   * Convert Backend EncryptedMessage to Olm EncryptedMessage format\n   */\n  convertEncryptedMessageFromBackend(backendMessage: BackendEncryptedMessage): EncryptedMessage {\n    return {\n      ciphertext: base64ToUint8Array(backendMessage.ciphertext),\n      messageType: backendMessage.messageType,\n    };\n  }\n\n  /**\n   * Convert Backend PreKeyBundle to Olm-compatible format\n   */\n  convertPreKeyBundleFromBackend(backendBundle: BackendPreKeyBundle): {\n    registrationId: number;\n    identityKey: Uint8Array;\n    signedPreKeyId: number;\n    signedPreKey: Uint8Array;\n    signedPreKeySignature: Uint8Array;\n    preKeyId?: number;\n    preKey?: Uint8Array;\n  } {\n    const result: any = {\n      registrationId: backendBundle.registrationId,\n      identityKey: base64ToUint8Array(backendBundle.identityKey),\n      signedPreKeyId: backendBundle.signedPreKeyId,\n      signedPreKey: base64ToUint8Array(backendBundle.signedPreKey),\n      signedPreKeySignature: base64ToUint8Array(backendBundle.signedPreKeySignature),\n    };\n\n    if (backendBundle.preKeyId !== undefined) {\n      result.preKeyId = backendBundle.preKeyId;\n    }\n    if (backendBundle.preKey !== undefined) {\n      result.preKey = base64ToUint8Array(backendBundle.preKey);\n    }\n\n    return result;\n  }\n\n  /**\n   * Adapt Olm pre-key bundle to Backend format\n   */\n  async adaptPreKeyBundleToBackend(): Promise<BackendPreKeyBundle> {\n    // Get Olm account identity keys\n    const identityKey = await this.olmProtocol.getIdentityPublicKey();\n    if (!identityKey) {\n      throw new Error('Identity key not available');\n    }\n\n    // Get Olm account signed pre-key (using the first one-time key as signed pre-key)\n    const oneTimeKeys = await this.olmProtocol.getOneTimeKeys();\n    const signedPreKeyEntries = Object.entries(oneTimeKeys.curve25519);\n    if (signedPreKeyEntries.length === 0) {\n      throw new Error('No signed pre-keys available');\n    }\n\n    const [signedPreKeyIdStr, signedPreKeyBase64] = signedPreKeyEntries[0];\n    const signedPreKeyId = parseInt(signedPreKeyIdStr);\n\n    // Generate a signature for the signed pre-key (simplified for compatibility)\n    // In Olm, we sign with the account's Ed25519 key\n    const signature = await this.olmProtocol.sign(signedPreKeyBase64);\n\n    // Get registration and device IDs\n    const registrationId = await this.olmProtocol.getRegistrationId();\n    const deviceId = await this.olmProtocol.getDeviceId();\n\n    return {\n      registrationId,\n      deviceId,\n      identityKey: uint8ArrayToBase64(identityKey),\n      signedPreKey: signedPreKeyBase64,\n      signedPreKeyId,\n      signedPreKeySignature: signature,\n      // Note: Olm doesn't have separate one-time pre-keys in the same way as Signal\n      // The one-time keys are handled differently in Olm\n    };\n  }\n\n  /**\n   * Create session with backend-compatible bundle\n   */\n  async createSessionWithBackendBundle(\n    recipientId: string,\n    deviceId: number,\n    backendBundle: BackendPreKeyBundle\n  ): Promise<void> {\n    const olmBundle = this.convertPreKeyBundleFromBackend(backendBundle);\n    return this.olmProtocol.createSession(recipientId, deviceId, olmBundle);\n  }\n\n  /**\n   * Encrypt message for backend\n   */\n  async encryptMessageForBackend(\n    recipientId: string,\n    deviceId: number,\n    plaintext: string\n  ): Promise<BackendEncryptedMessage> {\n    const olmMessage = await this.olmProtocol.encryptMessage(recipientId, deviceId, plaintext);\n    return this.convertEncryptedMessageToBackend(olmMessage);\n  }\n\n  /**\n   * Decrypt message from backend\n   */\n  async decryptMessageFromBackend(\n    senderId: string,\n    deviceId: number,\n    backendMessage: BackendEncryptedMessage\n  ): Promise<string> {\n    const olmMessage = this.convertEncryptedMessageFromBackend(backendMessage);\n    return this.olmProtocol.decryptMessage(senderId, deviceId, olmMessage.ciphertext, olmMessage.messageType);\n  }\n\n  /**\n   * Get pre-key bundle in backend format\n   */\n  async getPreKeyBundleForBackend(): Promise<BackendPreKeyBundle> {\n    return this.adaptPreKeyBundleToBackend();\n  }\n\n  /**\n   * Generate identity key pair in backend format\n   */\n  async generateIdentityKeyPairForBackend(): Promise<BackendKeyPair> {\n    const olmKeyPair = await this.olmProtocol.generateIdentityKeyPair();\n    return this.convertKeyPairToBackend(olmKeyPair);\n  }\n\n  /**\n   * Generate signed pre-key in backend format\n   */\n  async generateSignedPreKeyForBackend(keyId: number): Promise<BackendSignedPreKey> {\n    const olmSignedPreKey = await this.olmProtocol.generateSignedPreKey(keyId);\n    return this.convertSignedPreKeyToBackend(olmSignedPreKey);\n  }\n\n  /**\n   * Generate pre-keys in backend format\n   */\n  async generatePreKeysForBackend(startId: number, count: number): Promise<BackendPreKey[]> {\n    const olmPreKeys = await this.olmProtocol.generatePreKeys(startId, count);\n    return olmPreKeys.map(preKey => this.convertPreKeyToBackend(preKey));\n  }\n\n  /**\n   * Check if session exists\n   */\n  async hasSession(recipientId: string, deviceId: number): Promise<boolean> {\n    return this.olmProtocol.hasSession(recipientId, deviceId);\n  }\n\n  /**\n   * Delete session\n   */\n  async deleteSession(recipientId: string, deviceId: number): Promise<void> {\n    return this.olmProtocol.deleteSession(recipientId, deviceId);\n  }\n\n  /**\n   * Set up encryption with PIN\n   */\n  async setupEncryption(pin: string): Promise<void> {\n    return this.olmProtocol.setupEncryption(pin);\n  }\n\n  /**\n   * Unlock with PIN\n   */\n  async unlockWithPin(pin: string): Promise<void> {\n    return this.olmProtocol.unlockWithPin(pin);\n  }\n\n  /**\n   * Check if encryption is enabled\n   */\n  isEncryptionEnabled(): boolean {\n    return this.olmProtocol.isEncryptionEnabled();\n  }\n\n  /**\n   * Check if keys are unlocked\n   */\n  isUnlocked(): boolean {\n    return this.olmProtocol.isUnlocked();\n  }\n\n  /**\n   * Clear all stored data\n   */\n  async clear(): Promise<void> {\n    return this.olmProtocol.clear();\n  }\n}\n\n// Export singleton instance\nexport const protocolAdapter = new ProtocolAdapter();","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\signal.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\signal.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\storage.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\storage.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":45,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":48,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2712,2715],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2712,2715],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":112,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":112,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3320,3323],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3320,3323],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":140,"column":71,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":140,"endColumn":74,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4213,4216],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4213,4216],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":156,"column":42,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":156,"endColumn":45,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4804,4807],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4804,4807],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":4,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Local Storage Encryption Utilities\n *\n * Provides AES-256-GCM encryption/decryption for chat data stored in localStorage.\n * Uses the master key from the Signal Protocol for consistency with the PIN-based system.\n */\n\nimport { signalProtocol } from './signal';\n\n// Utility functions for base64 conversion\nfunction base64ToUint8Array(base64: string): Uint8Array {\n  const binary = atob(base64);\n  const bytes = new Uint8Array(binary.length);\n  for (let i = 0; i < binary.length; i++) {\n    bytes[i] = binary.charCodeAt(i);\n  }\n  return bytes;\n}\n\nfunction uint8ArrayToBase64(bytes: Uint8Array): string {\n  let binary = '';\n  for (let i = 0; i < bytes.length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary);\n}\n\n/**\n * Encrypt data with AES-256-GCM using the master key\n */\nasync function encryptWithMasterKey(\n  masterKey: Uint8Array,\n  data: string\n): Promise<{ ciphertext: string; iv: string }> {\n  const iv = crypto.getRandomValues(new Uint8Array(12));\n  const cryptoKey = await crypto.subtle.importKey(\n    'raw',\n    masterKey.buffer as ArrayBuffer,\n    { name: 'AES-GCM' },\n    false,\n    ['encrypt']\n  );\n\n  const plaintext = new TextEncoder().encode(data);\n  const ciphertext = await crypto.subtle.encrypt(\n    { name: 'AES-GCM', iv },\n    cryptoKey,\n    plaintext\n  );\n\n  return {\n    ciphertext: uint8ArrayToBase64(new Uint8Array(ciphertext)),\n    iv: uint8ArrayToBase64(iv),\n  };\n}\n\n/**\n * Decrypt data with AES-256-GCM using the master key\n */\nasync function decryptWithMasterKey(\n  masterKey: Uint8Array,\n  ciphertext: string,\n  iv: string\n): Promise<string> {\n  const cryptoKey = await crypto.subtle.importKey(\n    'raw',\n    masterKey.buffer as ArrayBuffer,\n    { name: 'AES-GCM' },\n    false,\n    ['decrypt']\n  );\n\n  const ciphertextBytes = base64ToUint8Array(ciphertext);\n  const ivBytes = base64ToUint8Array(iv);\n\n  // Create fresh ArrayBuffer copies to satisfy TypeScript BufferSource requirements\n  const ivBuffer = ivBytes.buffer.slice(ivBytes.byteOffset, ivBytes.byteOffset + ivBytes.byteLength) as ArrayBuffer;\n  const ciphertextBuffer = ciphertextBytes.buffer.slice(ciphertextBytes.byteOffset, ciphertextBytes.byteOffset + ciphertextBytes.byteLength) as ArrayBuffer;\n\n  const plaintext = await crypto.subtle.decrypt(\n    { name: 'AES-GCM', iv: ivBuffer },\n    cryptoKey,\n    ciphertextBuffer\n  );\n\n  return new TextDecoder().decode(plaintext);\n}\n\n/**\n * Encrypt chat data for localStorage\n *\n * @param data - The chat data to encrypt (will be JSON serialized)\n * @returns Base64 encoded encrypted data in format \"iv:ciphertext\"\n * @throws Error if encryption is not enabled or master key is not available\n */\nexport async function encryptChatData(data: any): Promise<string> {\n  try {\n    // Ensure Signal Protocol is initialized\n    await signalProtocol.initialize();\n\n    // Check if encryption is enabled\n    if (!signalProtocol.isEncryptionEnabled()) {\n      throw new Error('Encryption is not enabled - set up PIN encryption first');\n    }\n\n    // Check if master key is available (user has unlocked with PIN)\n    if (!signalProtocol.isUnlocked()) {\n      throw new Error('Master key not available - unlock with PIN first');\n    }\n\n    // Get master key (accessing private property - consider adding public getter)\n    const masterKey = (signalProtocol as any).masterKey as Uint8Array;\n    if (!masterKey) {\n      throw new Error('Master key not available');\n    }\n\n    // Serialize data to JSON\n    const jsonData = JSON.stringify(data);\n\n    // Encrypt the data\n    const { ciphertext, iv } = await encryptWithMasterKey(masterKey, jsonData);\n\n    // Return in format \"iv:ciphertext\" for easy storage\n    return `${iv}:${ciphertext}`;\n  } catch (error) {\n    if (error instanceof Error) {\n      throw new Error(`Failed to encrypt chat data: ${error.message}`);\n    }\n    throw new Error('Failed to encrypt chat data: Unknown error');\n  }\n}\n\n/**\n * Decrypt chat data from localStorage\n *\n * @param encryptedData - The encrypted data in format \"iv:ciphertext\"\n * @returns The decrypted chat data (JSON parsed)\n * @throws Error if decryption fails or encryption is not enabled\n */\nexport async function decryptChatData(encryptedData: string): Promise<any> {\n  try {\n    // Ensure Signal Protocol is initialized\n    await signalProtocol.initialize();\n\n    // Check if encryption is enabled\n    if (!signalProtocol.isEncryptionEnabled()) {\n      throw new Error('Encryption is not enabled - set up PIN encryption first');\n    }\n\n    // Check if master key is available (user has unlocked with PIN)\n    if (!signalProtocol.isUnlocked()) {\n      throw new Error('Master key not available - unlock with PIN first');\n    }\n\n    // Get master key (accessing private property - consider adding public getter)\n    const masterKey = (signalProtocol as any).masterKey as Uint8Array;\n    if (!masterKey) {\n      throw new Error('Master key not available');\n    }\n\n    // Parse the encrypted data format \"iv:ciphertext\"\n    const parts = encryptedData.split(':');\n    if (parts.length !== 2) {\n      throw new Error('Invalid encrypted data format');\n    }\n\n    const [iv, ciphertext] = parts;\n\n    // Decrypt the data\n    const jsonData = await decryptWithMasterKey(masterKey, ciphertext, iv);\n\n    // Parse JSON\n    return JSON.parse(jsonData);\n  } catch (error) {\n    if (error instanceof Error) {\n      throw new Error(`Failed to decrypt chat data: ${error.message}`);\n    }\n    throw new Error('Failed to decrypt chat data: Unknown error');\n  }\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\crypto\\test_pbkdf2_fix.js","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\services\\fileUpload.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\services\\webrtc.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\services\\websocket.test.spec.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'data' is defined but never used. Allowed unused args must match /^_/u.","line":26,"column":8,"nodeType":null,"messageId":"unusedVar","endLine":26,"endColumn":12},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":54,"column":26,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":54,"endColumn":29,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1439,1442],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1439,1442],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":55,"column":23,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":55,"endColumn":26,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1466,1469],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1466,1469],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":60,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":60,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1604,1607],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1604,1607],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":84,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":84,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2215,2218],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2215,2218],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":130,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":130,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'connectSpy' is assigned a value but never used.","line":147,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":147,"endColumn":23},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":147,"column":46,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":147,"endColumn":49,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4040,4043],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4040,4043],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":191,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":191,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":278,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":278,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":311,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":311,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":342,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":342,"endColumn":21},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":371,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":371,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10654,10657],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10654,10657],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":400,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":400,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11607,11610],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11607,11610],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'service' is assigned a value but never used.","line":416,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":416,"endColumn":20},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":452,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":452,"endColumn":21},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'error' is defined but never used.","line":605,"column":16,"nodeType":null,"messageId":"unusedVar","endLine":605,"endColumn":21}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":17,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * WebSocket Service Authentication Tests\n *\n * Comprehensive test suite for WebSocket authentication and authorization mechanisms\n */\n\nimport { WebSocketService } from './websocket';\nimport { describe, expect, test, vi, beforeEach, afterEach } from 'vitest';\n\n// Mock WebSocket implementation\nclass MockWebSocket {\n  url: string;\n  protocols?: string | string[];\n  onopen: (() => void) | null = null;\n  onmessage: ((event: { data: string }) => void) | null = null;\n  onclose: (() => void) | null = null;\n  onerror: ((error: Event) => void) | null = null;\n  readyState: number = WebSocket.OPEN;\n  closeCalled = false;\n\n  constructor(url: string, protocols?: string | string[]) {\n    this.url = url;\n    this.protocols = protocols;\n  }\n\n  send(data: string): void {\n    // Mock send implementation\n  }\n\n  close(): void {\n    this.closeCalled = true;\n    if (this.onclose) {\n      this.onclose();\n    }\n  }\n}\n\n// Mock crypto implementation for testing\nconst mockCrypto = {\n  subtle: {\n    importKey: vi.fn().mockResolvedValue({}),\n    sign: vi.fn().mockResolvedValue(new Uint8Array([1, 2, 3, 4])),\n  },\n  getRandomValues: vi.fn().mockImplementation((array: Uint8Array) => {\n    for (let i = 0; i < array.length; i++) {\n      array[i] = Math.floor(Math.random() * 256);\n    }\n    return array;\n  }),\n  randomUUID: vi.fn().mockReturnValue('test-uuid-12345'),\n};\n\ndescribe('WebSocket Authentication Tests', () => {\n  let originalWebSocket: any;\n  let originalCrypto: any;\n\n  beforeEach(() => {\n    // Mock WebSocket global\n    originalWebSocket = global.WebSocket;\n    global.WebSocket = MockWebSocket as any;\n\n    // Mock crypto\n    originalCrypto = global.crypto;\n    global.crypto = mockCrypto;\n\n    // Reset mocks\n    vi.resetAllMocks();\n  });\n\n  afterEach(() => {\n    // Restore originals\n    global.WebSocket = originalWebSocket;\n    global.crypto = originalCrypto;\n  });\n\n  describe('Token-Based Authentication', () => {\n    test('should authenticate using Sec-WebSocket-Protocol header', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n      };\n\n      const service = new WebSocketService(config);\n      const connectSpy = vi.spyOn(service as any, 'connect');\n\n      // Mock WebSocket connection\n      await service.connect();\n\n      // Verify WebSocket was created with correct protocols\n      expect(connectSpy).toHaveBeenCalled();\n    });\n\n    test('should handle connection with valid token', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'valid-token-12345',\n        onConnect: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n      await service.connect();\n\n      // Verify onConnect was called\n      expect(config.onConnect).toHaveBeenCalled();\n    });\n\n    test('should fail connection with invalid token', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'invalid-token-12345',\n        onError: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to simulate connection error\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce(() => {\n        const mockWs = new MockWebSocket(config.url, ['Bearer', config.token]);\n        mockWs.readyState = WebSocket.CLOSED;\n        setTimeout(() => {\n          if (mockWs.onerror) {\n            mockWs.onerror(new Event('error'));\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      try {\n        await service.connect();\n      } catch (error) {\n        // Expected to fail\n      }\n\n      // Verify onError was called\n      expect(config.onError).toHaveBeenCalled();\n    });\n  });\n\n  describe('Sec-WebSocket-Protocol Header Authentication', () => {\n    test('should use Sec-WebSocket-Protocol for browser WebSocket API', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n      };\n\n      const service = new WebSocketService(config);\n      const connectSpy = vi.spyOn(service as any, 'connect');\n\n      // Mock WebSocket to capture protocols\n      let capturedProtocols: string | string[] | undefined;\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce((url: string, protocols?: string | string[]) => {\n        capturedProtocols = protocols;\n        const mockWs = new MockWebSocket(url, protocols);\n        setTimeout(() => {\n          if (mockWs.onopen) {\n            mockWs.onopen();\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      await service.connect();\n\n      // Verify Sec-WebSocket-Protocol was used\n      expect(capturedProtocols).toEqual(['Bearer', config.token]);\n    });\n\n    test('should handle malformed Sec-WebSocket-Protocol header', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n        onError: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to simulate protocol error\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce(() => {\n        const mockWs = new MockWebSocket(config.url, ['InvalidFormat']);\n        mockWs.readyState = WebSocket.CLOSED;\n        setTimeout(() => {\n          if (mockWs.onerror) {\n            mockWs.onerror(new Event('error'));\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      try {\n        await service.connect();\n      } catch (error) {\n        // Expected to fail\n      }\n\n      // Verify error handling\n      expect(config.onError).toHaveBeenCalled();\n    });\n  });\n\n  describe('Query Parameter Authentication Fallback', () => {\n    test('should use query parameter fallback when headers not available', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws?token=test-token-12345',\n        token: 'test-token-12345',\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to capture URL with query parameter\n      let capturedUrl: string | undefined;\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce((url: string, protocols?: string | string[]) => {\n        capturedUrl = url;\n        const mockWs = new MockWebSocket(url, protocols);\n        setTimeout(() => {\n          if (mockWs.onopen) {\n            mockWs.onopen();\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      await service.connect();\n\n      // Verify URL contains token query parameter\n      expect(capturedUrl).toContain('token=test-token-12345');\n    });\n  });\n\n  describe('JWT Token Validation and Claims Verification', () => {\n    test('should validate JWT token format', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'valid.jwt.token.12345',\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock successful connection\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce((url: string, protocols?: string | string[]) => {\n        const mockWs = new MockWebSocket(url, protocols);\n        setTimeout(() => {\n          if (mockWs.onopen) {\n            mockWs.onopen();\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      await service.connect();\n\n      // Connection should succeed with valid token format\n      expect(service.isConnected()).toBe(true);\n    });\n\n    test('should handle expired JWT token', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'expired.jwt.token.12345',\n        onError: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to simulate token expiration error\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce(() => {\n        const mockWs = new MockWebSocket(config.url, ['Bearer', config.token]);\n        mockWs.readyState = WebSocket.CLOSED;\n        setTimeout(() => {\n          if (mockWs.onerror) {\n            mockWs.onerror(new Event('error'));\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      try {\n        await service.connect();\n      } catch (error) {\n        // Expected to fail\n      }\n\n      // Verify error handling\n      expect(config.onError).toHaveBeenCalled();\n    });\n  });\n\n  describe('Connection Rate Limiting and IP-Based Security', () => {\n    test('should handle rate limiting errors', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n        onError: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to simulate rate limiting error\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce(() => {\n        const mockWs = new MockWebSocket(config.url, ['Bearer', config.token]);\n        mockWs.readyState = WebSocket.CLOSED;\n        setTimeout(() => {\n          if (mockWs.onerror) {\n            mockWs.onerror(new Event('error'));\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      try {\n        await service.connect();\n      } catch (error) {\n        // Expected to fail\n      }\n\n      // Verify error handling\n      expect(config.onError).toHaveBeenCalled();\n    });\n\n    test('should handle IP-based security blocking', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n        onError: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to simulate IP blocking error\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce(() => {\n        const mockWs = new MockWebSocket(config.url, ['Bearer', config.token]);\n        mockWs.readyState = WebSocket.CLOSED;\n        setTimeout(() => {\n          if (mockWs.onerror) {\n            mockWs.onerror(new Event('error'));\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      try {\n        await service.connect();\n      } catch (error) {\n        // Expected to fail\n      }\n\n      // Verify error handling\n      expect(config.onError).toHaveBeenCalled();\n    });\n  });\n\n  describe('Message HMAC Verification', () => {\n    test('should generate valid HMAC signature', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345678901234567890123456789012', // 32+ chars\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock crypto operations\n      mockCrypto.subtle.importKey.mockResolvedValueOnce({});\n      mockCrypto.subtle.sign.mockResolvedValueOnce(new Uint8Array([1, 2, 3, 4]));\n\n      const message = {\n        type: 'test',\n        payload: { test: 'data' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const signature = await (service as any).generateMessageSignature(message);\n\n      // Verify signature generation was attempted\n      expect(mockCrypto.subtle.importKey).toHaveBeenCalled();\n      expect(mockCrypto.subtle.sign).toHaveBeenCalled();\n      expect(signature).toBeDefined();\n    });\n\n    test('should verify message signatures', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345678901234567890123456789012',\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock crypto operations\n      mockCrypto.subtle.importKey.mockResolvedValue({});\n      mockCrypto.subtle.sign.mockResolvedValue(new Uint8Array([1, 2, 3, 4]));\n\n      const message = {\n        type: 'test',\n        payload: { test: 'data' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n        signature: '01020304', // Mock signature\n        nonce: [1, 2, 3, 4],\n      };\n\n      const isValid = await (service as any).verifyMessageSignature(message);\n\n      // Verify signature verification was attempted\n      expect(mockCrypto.subtle.importKey).toHaveBeenCalled();\n      expect(mockCrypto.subtle.sign).toHaveBeenCalled();\n      expect(isValid).toBeDefined();\n    });\n  });\n\n  describe('Replay Attack Protection', () => {\n    test('should detect replay attacks using nonces', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n      };\n\n      const service = new WebSocketService(config);\n\n      // This would be tested more thoroughly in integration tests\n      // For unit test, we verify the nonce generation\n      const nonce1 = Array.from(mockCrypto.getRandomValues(new Uint8Array(16)));\n      const nonce2 = Array.from(mockCrypto.getRandomValues(new Uint8Array(16)));\n\n      // Nonces should be different (random)\n      expect(nonce1).not.toEqual(nonce2);\n    });\n  });\n\n  describe('Error Handling and Logging', () => {\n    test('should handle connection errors gracefully', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n        onError: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to simulate connection error\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce(() => {\n        const mockWs = new MockWebSocket(config.url, ['Bearer', config.token]);\n        mockWs.readyState = WebSocket.CLOSED;\n        setTimeout(() => {\n          if (mockWs.onerror) {\n            mockWs.onerror(new Event('connection_error'));\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      try {\n        await service.connect();\n      } catch (error) {\n        // Expected to fail\n      }\n\n      // Verify error callback was called\n      expect(config.onError).toHaveBeenCalled();\n    });\n\n    test('should handle message parsing errors', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket connection\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce((url: string, protocols?: string | string[]) => {\n        const mockWs = new MockWebSocket(url, protocols);\n        setTimeout(() => {\n          if (mockWs.onopen) {\n            mockWs.onopen();\n          }\n          // Send invalid message\n          if (mockWs.onmessage) {\n            mockWs.onmessage({ data: 'invalid-json-data' });\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      // Mock console.error to verify error logging\n      const consoleErrorSpy = vi.spyOn(console, 'error').mockImplementation(() => {});\n\n      await service.connect();\n\n      // Verify error was logged but didn't crash\n      expect(consoleErrorSpy).toHaveBeenCalledWith(\n        expect.stringContaining('Failed to parse WebSocket message')\n      );\n\n      consoleErrorSpy.mockRestore();\n    });\n  });\n\n  describe('Authentication Flow Integration', () => {\n    test('should handle complete authentication flow', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'valid-integration-token-12345',\n        onConnect: vi.fn(),\n        onDisconnect: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock successful WebSocket connection\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce((url: string, protocols?: string | string[]) => {\n        const mockWs = new MockWebSocket(url, protocols);\n        setTimeout(() => {\n          if (mockWs.onopen) {\n            mockWs.onopen();\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      // Connect\n      await service.connect();\n\n      // Verify connection callbacks\n      expect(config.onConnect).toHaveBeenCalled();\n      expect(service.isConnected()).toBe(true);\n\n      // Disconnect\n      service.disconnect();\n\n      // Verify disconnection\n      expect(config.onDisconnect).toHaveBeenCalled();\n    });\n\n    test('should handle authentication priority correctly', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws?token=query-token-12345',\n        token: 'header-token-12345',\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to capture both URL and protocols\n      let capturedUrl: string | undefined;\n      let capturedProtocols: string | string[] | undefined;\n\n      vi.spyOn(global, 'WebSocket').mockImplementationOnce((url: string, protocols?: string | string[]) => {\n        capturedUrl = url;\n        capturedProtocols = protocols;\n        const mockWs = new MockWebSocket(url, protocols);\n        setTimeout(() => {\n          if (mockWs.onopen) {\n            mockWs.onopen();\n          }\n        }, 10);\n        return mockWs;\n      });\n\n      await service.connect();\n\n      // Verify both methods are available but header token is used in protocols\n      expect(capturedUrl).toContain('token=query-token-12345');\n      expect(capturedProtocols).toEqual(['Bearer', 'header-token-12345']);\n    });\n  });\n\n  describe('Performance and Stress Testing', () => {\n    test('should handle rapid reconnection attempts', async () => {\n      const config = {\n        url: 'wss://test-server.com/ws',\n        token: 'test-token-12345',\n        onError: vi.fn(),\n      };\n\n      const service = new WebSocketService(config);\n\n      // Mock WebSocket to fail initially then succeed\n      let attemptCount = 0;\n      vi.spyOn(global, 'WebSocket').mockImplementation((url: string, protocols?: string | string[]) => {\n        attemptCount++;\n        const mockWs = new MockWebSocket(url, protocols);\n\n        if (attemptCount < 3) {\n          // Fail first 2 attempts\n          mockWs.readyState = WebSocket.CLOSED;\n          setTimeout(() => {\n            if (mockWs.onerror) {\n              mockWs.onerror(new Event('error'));\n            }\n          }, 10);\n        } else {\n          // Succeed on 3rd attempt\n          setTimeout(() => {\n            if (mockWs.onopen) {\n              mockWs.onopen();\n            }\n          }, 10);\n        }\n\n        return mockWs;\n      });\n\n      // This would normally be tested with actual reconnection logic\n      // For unit test, we verify the error handling\n      try {\n        await service.connect();\n      } catch (error) {\n        // Expected to fail initially\n      }\n\n      expect(config.onError).toHaveBeenCalled();\n    });\n  });\n});","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\services\\websocket.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'WSMessage' is defined but never used.","line":9,"column":15,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":24},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'EncryptedPayload' is defined but never used.","line":9,"column":41,"nodeType":null,"messageId":"unusedVar","endLine":9,"endColumn":57},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":67,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":67,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2221,2224],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2221,2224],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'originalImportKey' is assigned a value but never used.","line":83,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":83,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'algorithm' is defined but never used. Allowed unused args must match /^_/u.","line":86,"column":76,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":85},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'extractable' is defined but never used. Allowed unused args must match /^_/u.","line":86,"column":87,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":98},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'keyUsages' is defined but never used. Allowed unused args must match /^_/u.","line":86,"column":100,"nodeType":null,"messageId":"unusedVar","endLine":86,"endColumn":109},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":91,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":91,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3056,3059],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3056,3059],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'originalImportKey' is assigned a value but never used.","line":112,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":112,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'algorithm' is defined but never used. Allowed unused args must match /^_/u.","line":115,"column":76,"nodeType":null,"messageId":"unusedVar","endLine":115,"endColumn":85},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'extractable' is defined but never used. Allowed unused args must match /^_/u.","line":115,"column":87,"nodeType":null,"messageId":"unusedVar","endLine":115,"endColumn":98},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'keyUsages' is defined but never used. Allowed unused args must match /^_/u.","line":115,"column":100,"nodeType":null,"messageId":"unusedVar","endLine":115,"endColumn":109},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":120,"column":35,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":120,"endColumn":38,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4060,4063],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4060,4063],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'originalImportKey' is assigned a value but never used.","line":143,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":143,"endColumn":30},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'algorithm' is defined but never used. Allowed unused args must match /^_/u.","line":146,"column":76,"nodeType":null,"messageId":"unusedVar","endLine":146,"endColumn":85},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'extractable' is defined but never used. Allowed unused args must match /^_/u.","line":146,"column":87,"nodeType":null,"messageId":"unusedVar","endLine":146,"endColumn":98},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'keyUsages' is defined but never used. Allowed unused args must match /^_/u.","line":146,"column":100,"nodeType":null,"messageId":"unusedVar","endLine":146,"endColumn":109},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":151,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":151,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5294,5297],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5294,5297],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":169,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":169,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5926,5929],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5926,5929],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":179,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":179,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6243,6246],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6243,6246],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'validSignature' is assigned a value but never used.","line":193,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":193,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":193,"column":48,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":193,"endColumn":51,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[6657,6660],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[6657,6660],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":203,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":203,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7011,7014],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7011,7014],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":217,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":217,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7432,7435],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7432,7435],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":230,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":230,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[7817,7820],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[7817,7820],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":238,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":238,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8017,8020],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8017,8020],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":254,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":254,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8513,8516],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8513,8516],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":265,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":265,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[8940,8943],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[8940,8943],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":279,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":279,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9369,9372],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9369,9372],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":290,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":290,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9766,9769],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9766,9769],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":304,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":304,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10192,10195],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10192,10195],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":315,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":315,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10597,10600],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10597,10600],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":349,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":349,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11648,11651],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11648,11651],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":350,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":350,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11732,11735],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11732,11735],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":380,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":380,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12641,12644],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12641,12644],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'invalidMessage' is assigned a value but never used.","line":396,"column":13,"nodeType":null,"messageId":"unusedVar","endLine":396,"endColumn":27},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":402,"column":40,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":402,"endColumn":43,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13438,13441],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13438,13441],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":415,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":415,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[13904,13907],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[13904,13907],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":426,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":426,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14292,14295],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14292,14295],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":442,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":442,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[14781,14784],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[14781,14784],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":456,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":456,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15203,15206],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15203,15206],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":478,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":478,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[15897,15900],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[15897,15900],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":493,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":493,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16354,16357],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16354,16357],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":503,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":503,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[16661,16664],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[16661,16664],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":523,"column":39,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":523,"endColumn":42,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17276,17279],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17276,17279],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":539,"column":44,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":539,"endColumn":47,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[17892,17895],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[17892,17895],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":557,"column":25,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":557,"endColumn":28,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[18558,18561],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[18558,18561],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":577,"column":43,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":577,"endColumn":46,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19220,19223],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19220,19223],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":586,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":586,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19497,19500],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19497,19500],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":593,"column":54,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":593,"endColumn":57,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[19715,19718],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[19715,19718],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":50,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * WebSocket Service - Comprehensive Security Tests\n *\n * Tests for WebSocket message encryption, integrity, and security mechanisms\n * Covers HMAC signing/verification, replay attack protection, and message validation\n */\nimport { describe, expect, test, vi, beforeEach, afterEach } from 'vitest';\nimport { WebSocketService } from './websocket';\nimport type { WSMessage, WSMessageType, EncryptedPayload } from '../types';\n\n// Mock crypto for deterministic testing\nconst mockCrypto = {\n  randomUUID: () => 'test-uuid-1234-5678-9012-345678901234',\n  getRandomValues: (array: Uint8Array) => {\n    // Fill with predictable values for testing\n    for (let i = 0; i < array.length; i++) {\n      array[i] = i % 256;\n    }\n    return array;\n  },\n  subtle: {\n    importKey: vi.fn(),\n    sign: vi.fn(),\n  }\n};\n\n// Mock global crypto\nvi.stubGlobal('crypto', mockCrypto);\n\ndescribe('WebSocket Message Security - HMAC Signing and Verification', () => {\n  let service: WebSocketService;\n  const testToken = 'test-token-with-32-bytes-length-1234567890';\n  const testConfig = {\n    url: 'ws://localhost:8080/ws',\n    token: testToken,\n  };\n\n  beforeEach(() => {\n    service = new WebSocketService(testConfig);\n\n    // Mock crypto.subtle.importKey to return a mock key\n    mockCrypto.subtle.importKey.mockResolvedValue({});\n\n    // Mock crypto.subtle.sign to return predictable HMAC\n    mockCrypto.subtle.sign.mockImplementation((algorithm, key, data) => {\n      // Create a predictable HMAC based on input data\n      const dataStr = new TextDecoder().decode(data as Uint8Array);\n      const hmac = `predictable-hmac-${dataStr.length}-${dataStr.substring(0, 20)}`;\n      return new TextEncoder().encode(hmac);\n    });\n  });\n\n  afterEach(() => {\n    vi.restoreAllMocks();\n  });\n\n  describe('HMAC-SHA256 Message Signing', () => {\n    test('should generate HMAC signature with correct key derivation', async () => {\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext', messageType: 'whisper' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Call the private method via reflection or create a test wrapper\n      const signature = await (service as any).generateMessageSignature(testMessage);\n\n      expect(signature).toBeTruthy();\n      expect(typeof signature).toBe('string');\n      expect(signature.length).toBeGreaterThan(0);\n    });\n\n    test('should use token-based HMAC key derivation (32-byte key)', async () => {\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Mock to verify key derivation\n      const originalImportKey = mockCrypto.subtle.importKey;\n      let capturedKey: Uint8Array | null = null;\n\n      mockCrypto.subtle.importKey.mockImplementationOnce((format, keyData, algorithm, extractable, keyUsages) => {\n        capturedKey = keyData as Uint8Array;\n        return Promise.resolve({});\n      });\n\n      await (service as any).generateMessageSignature(testMessage);\n\n      expect(capturedKey).toBeTruthy();\n      expect(capturedKey?.length).toBe(32); // Should be exactly 32 bytes for SHA-256\n    });\n\n    test('should handle token padding for keys shorter than 32 bytes', async () => {\n      // Create service with short token\n      const shortTokenService = new WebSocketService({\n        ...testConfig,\n        token: 'short',\n      });\n\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Mock to verify key derivation with padding\n      const originalImportKey = mockCrypto.subtle.importKey;\n      let capturedKey: Uint8Array | null = null;\n\n      mockCrypto.subtle.importKey.mockImplementationOnce((format, keyData, algorithm, extractable, keyUsages) => {\n        capturedKey = keyData as Uint8Array;\n        return Promise.resolve({});\n      });\n\n      await (shortTokenService as any).generateMessageSignature(testMessage);\n\n      expect(capturedKey).toBeTruthy();\n      expect(capturedKey?.length).toBe(32); // Should be padded to 32 bytes\n      expect(capturedKey?.slice(0, 5)).toEqual(new TextEncoder().encode('short'));\n      expect(capturedKey?.slice(5)).toEqual(new Uint8Array(27)); // Padded with zeros\n    });\n\n    test('should handle token truncation for keys longer than 32 bytes', async () => {\n      const longToken = 'very-long-token-that-is-definitely-more-than-32-bytes-long-12345678901234567890';\n      const longTokenService = new WebSocketService({\n        ...testConfig,\n        token: longToken,\n      });\n\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Mock to verify key derivation with truncation\n      const originalImportKey = mockCrypto.subtle.importKey;\n      let capturedKey: Uint8Array | null = null;\n\n      mockCrypto.subtle.importKey.mockImplementationOnce((format, keyData, algorithm, extractable, keyUsages) => {\n        capturedKey = keyData as Uint8Array;\n        return Promise.resolve({});\n      });\n\n      await (longTokenService as any).generateMessageSignature(testMessage);\n\n      expect(capturedKey).toBeTruthy();\n      expect(capturedKey?.length).toBe(32); // Should be truncated to 32 bytes\n      expect(capturedKey).toEqual(new TextEncoder().encode(longToken).slice(0, 32));\n    });\n  });\n\n  describe('HMAC-SHA256 Message Verification', () => {\n    test('should verify valid HMAC signatures', async () => {\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Generate signature\n      const signature = await (service as any).generateMessageSignature(testMessage);\n\n      // Create signed message\n      const signedMessage = {\n        ...testMessage,\n        signature,\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15], // Predictable nonce\n      };\n\n      // Verify signature\n      const isValid = await (service as any).verifyMessageSignature(signedMessage);\n\n      expect(isValid).toBe(true);\n    });\n\n    test('should reject invalid HMAC signatures', async () => {\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Generate valid signature\n      const validSignature = await (service as any).generateMessageSignature(testMessage);\n\n      // Create signed message with tampered signature\n      const tamperedMessage = {\n        ...testMessage,\n        signature: 'invalid-signature-1234567890',\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],\n      };\n\n      // Verify signature\n      const isValid = await (service as any).verifyMessageSignature(tamperedMessage);\n\n      expect(isValid).toBe(false);\n    });\n\n    test('should reject messages without signature', async () => {\n      const messageWithoutSignature = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n        // No signature field\n      };\n\n      const isValid = await (service as any).verifyMessageSignature(messageWithoutSignature);\n\n      expect(isValid).toBe(false);\n    });\n\n    test('should reject messages without nonce', async () => {\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const signature = await (service as any).generateMessageSignature(testMessage);\n\n      const messageWithoutNonce = {\n        ...testMessage,\n        signature,\n        // No nonce field\n      };\n\n      const isValid = await (service as any).verifyMessageSignature(messageWithoutNonce);\n\n      expect(isValid).toBe(false);\n    });\n  });\n\n  describe('Message Tampering Detection', () => {\n    test('should detect tampered message content', async () => {\n      const originalMessage = {\n        type: 'send',\n        payload: { ciphertext: 'original-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Generate signature for original message\n      const signature = await (service as any).generateMessageSignature(originalMessage);\n\n      // Create tampered message\n      const tamperedMessage = {\n        ...originalMessage,\n        signature,\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],\n        payload: { ciphertext: 'tampered-ciphertext' }, // Tampered payload\n      };\n\n      // Verify signature - should fail because content was tampered\n      const isValid = await (service as any).verifyMessageSignature(tamperedMessage);\n\n      expect(isValid).toBe(false);\n    });\n\n    test('should detect tampered message type', async () => {\n      const originalMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Generate signature for original message\n      const signature = await (service as any).generateMessageSignature(originalMessage);\n\n      // Create tampered message\n      const tamperedMessage = {\n        ...originalMessage,\n        type: 'deliver', // Changed message type\n        signature,\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],\n      };\n\n      // Verify signature - should fail because type was tampered\n      const isValid = await (service as any).verifyMessageSignature(tamperedMessage);\n\n      expect(isValid).toBe(false);\n    });\n\n    test('should detect tampered timestamp', async () => {\n      const originalMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: 1234567890,\n        messageId: 'test-message-id',\n      };\n\n      // Generate signature for original message\n      const signature = await (service as any).generateMessageSignature(originalMessage);\n\n      // Create tampered message\n      const tamperedMessage = {\n        ...originalMessage,\n        timestamp: 9876543210, // Changed timestamp\n        signature,\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],\n      };\n\n      // Verify signature - should fail because timestamp was tampered\n      const isValid = await (service as any).verifyMessageSignature(tamperedMessage);\n\n      expect(isValid).toBe(false);\n    });\n  });\n\n  describe('Nonce-Based Replay Attack Protection', () => {\n    test('should generate unique nonces for each message', async () => {\n      const message1 = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext-1' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id-1',\n      };\n\n      const message2 = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext-2' },\n        timestamp: Date.now() + 1,\n        messageId: 'test-message-id-2',\n      };\n\n      // Mock getRandomValues to return different values\n      let callCount = 0;\n      const originalGetRandomValues = mockCrypto.getRandomValues;\n      mockCrypto.getRandomValues = (array: Uint8Array) => {\n        callCount++;\n        for (let i = 0; i < array.length; i++) {\n          array[i] = (i + callCount) % 256;\n        }\n        return array;\n      };\n\n      // Generate signatures for both messages\n      const signature1 = await (service as any).generateMessageSignature(message1);\n      const signature2 = await (service as any).generateMessageSignature(message2);\n\n      // Create signed messages\n      const signedMessage1 = {\n        ...message1,\n        signature: signature1,\n        nonce: Array.from(mockCrypto.getRandomValues(new Uint8Array(16))),\n      };\n\n      const signedMessage2 = {\n        ...message2,\n        signature: signature2,\n        nonce: Array.from(mockCrypto.getRandomValues(new Uint8Array(16))),\n      };\n\n      // Nonces should be different\n      expect(signedMessage1.nonce).not.toEqual(signedMessage2.nonce);\n\n      // Restore original\n      mockCrypto.getRandomValues = originalGetRandomValues;\n    });\n\n    test('should use 128-bit nonces for replay protection', async () => {\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const signature = await (service as any).generateMessageSignature(testMessage);\n\n      const signedMessage = {\n        ...testMessage,\n        signature,\n        nonce: Array.from(mockCrypto.getRandomValues(new Uint8Array(16))),\n      };\n\n      // Nonce should be 128 bits (16 bytes)\n      expect(signedMessage.nonce).toHaveLength(16);\n      expect(signedMessage.nonce.every((val: number) => typeof val === 'number' && val >= 0 && val <= 255)).toBe(true);\n    });\n  });\n\n  describe('Message Structure and Payload Validation', () => {\n    test('should validate message structure before processing', async () => {\n      const invalidMessage = {\n        // Missing required fields\n        payload: { ciphertext: 'test-ciphertext' },\n      };\n\n      // This should be caught by the message handler\n      const result = await (service as any).isPayloadValidationRequired('send');\n      expect(result).toBe(true);\n    });\n\n    test('should validate payload structure for different message types', async () => {\n      // Test validation for 'send' message type\n      const sendMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext', messageType: 'whisper' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const isValid = await (service as any).validatePayload(sendMessage);\n      expect(isValid).toBe(true);\n\n      // Test validation for invalid 'send' message (missing ciphertext)\n      const invalidSendMessage = {\n        type: 'send',\n        payload: { messageType: 'whisper' }, // Missing ciphertext\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const isInvalid = await (service as any).validatePayload(invalidSendMessage);\n      expect(isInvalid).toBe(false);\n    });\n\n    test('should validate read receipt payload structure', async () => {\n      const validReadReceipt = {\n        type: 'read_receipt',\n        payload: {\n          messageId: 'test-message-id',\n          conversationId: 'test-conversation-id',\n          status: 'read',\n        },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const isValid = await (service as any).validatePayload(validReadReceipt);\n      expect(isValid).toBe(true);\n\n      // Test invalid read receipt (missing messageId)\n      const invalidReadReceipt = {\n        type: 'read_receipt',\n        payload: {\n          conversationId: 'test-conversation-id',\n          status: 'read',\n        },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const isInvalid = await (service as any).validatePayload(invalidReadReceipt);\n      expect(isInvalid).toBe(false);\n    });\n  });\n\n  describe('Cross-Platform Compatibility', () => {\n    test('should handle different token encodings consistently', async () => {\n      // Test with UTF-8 token\n      const utf8Token = 'test-token-├▒├í├⌐├¡├│├║-1234567890';\n      const utf8Service = new WebSocketService({\n        ...testConfig,\n        token: utf8Token,\n      });\n\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Should handle UTF-8 encoding properly\n      const signature = await (utf8Service as any).generateMessageSignature(testMessage);\n      expect(signature).toBeTruthy();\n    });\n\n    test('should handle special characters in message content', async () => {\n      const testMessage = {\n        type: 'send',\n        payload: {\n          ciphertext: 'test-ciphertext-├▒├í├⌐├¡├│├║-≡ƒÜÇ≡ƒöÆ',\n          messageType: 'whisper',\n        },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const signature = await (service as any).generateMessageSignature(testMessage);\n      expect(signature).toBeTruthy();\n\n      // Verify the signature\n      const signedMessage = {\n        ...testMessage,\n        signature,\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],\n      };\n\n      const isValid = await (service as any).verifyMessageSignature(signedMessage);\n      expect(isValid).toBe(true);\n    });\n  });\n\n  describe('Error Handling and Security', () => {\n    test('should handle missing authentication token gracefully', async () => {\n      const noTokenService = new WebSocketService({\n        url: 'ws://localhost:8080/ws',\n        token: '',\n      });\n\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Should throw error when no token available\n      await expect((noTokenService as any).generateMessageSignature(testMessage))\n        .rejects.toThrow('No authentication token available for message signing');\n    });\n\n    test('should handle crypto API failures gracefully', async () => {\n      // Mock crypto.subtle.importKey to fail\n      mockCrypto.subtle.importKey.mockRejectedValueOnce(new Error('Crypto API failed'));\n\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      // Should handle crypto failure gracefully\n      const signaturePromise = (service as any).generateMessageSignature(testMessage);\n      await expect(signaturePromise).rejects.toBeTruthy();\n    });\n\n    test('should disconnect on signature verification failure', async () => {\n      // Mock disconnect to track calls\n      const disconnectSpy = vi.spyOn(service, 'disconnect');\n\n      const testMessage = {\n        type: 'send',\n        payload: { ciphertext: 'test-ciphertext' },\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n        signature: 'invalid-signature',\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],\n      };\n\n      // Simulate message handling with invalid signature\n      await (service as any).handleMessage(JSON.stringify(testMessage));\n\n      // Should have called disconnect\n      expect(disconnectSpy).toHaveBeenCalled();\n    });\n  });\n\n  describe('Message Type Specific Tests', () => {\n    const messageTypes: WSMessageType[] = [\n      'send', 'deliver', 'read_receipt', 'typing', 'heartbeat', 'status_update'\n    ];\n\n    test.each(messageTypes)('should handle %s message type with signing', async (messageType) => {\n      const testMessage = {\n        type: messageType,\n        payload: getTestPayloadForType(messageType),\n        timestamp: Date.now(),\n        messageId: 'test-message-id',\n      };\n\n      const signature = await (service as any).generateMessageSignature(testMessage);\n      expect(signature).toBeTruthy();\n\n      const signedMessage = {\n        ...testMessage,\n        signature,\n        nonce: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],\n      };\n\n      const isValid = await (service as any).verifyMessageSignature(signedMessage);\n      expect(isValid).toBe(true);\n    });\n  });\n});\n\n// Helper function to get appropriate test payload for message type\nfunction getTestPayloadForType(type: WSMessageType): any {\n  switch (type) {\n    case 'send':\n      return { ciphertext: 'test-ciphertext', messageType: 'whisper' };\n    case 'deliver':\n      return { ciphertext: 'test-ciphertext', messageType: 'whisper' };\n    case 'read_receipt':\n      return { messageId: 'test-message-id', conversationId: 'test-conversation-id', status: 'read' };\n    case 'typing':\n      return { recipientId: 'test-recipient-id', isTyping: true };\n    case 'heartbeat':\n      return {};\n    case 'status_update':\n      return { messageId: 'test-message-id', status: 'delivered' };\n    default:\n      return {};\n  }\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\services\\websocket.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":171,"column":14,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":171,"endColumn":17,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5079,5082],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5079,5082],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":177,"column":75,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":177,"endColumn":78,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5241,5244],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5241,5244],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":328,"column":20,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":328,"endColumn":23,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[9954,9957],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[9954,9957],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":334,"column":92,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":334,"endColumn":95,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[10141,10144],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[10141,10144],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":365,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":365,"endColumn":53,"suggestions":[{"messageId":"addBrackets","fix":{"range":[11143,11443],"text":"{ if (!message.payload || typeof message.payload !== 'object') {\r\n            return false;\r\n          }\r\n          const msgPayload = message.payload as any;\r\n          if (!msgPayload.ciphertext || typeof msgPayload.ciphertext !== 'string') {\r\n            return false;\r\n          }\r\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":365,"column":49,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":365,"endColumn":52,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11295,11298],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11295,11298],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":375,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":375,"endColumn":57,"suggestions":[{"messageId":"addBrackets","fix":{"range":[11487,11797],"text":"{ if (!message.payload || typeof message.payload !== 'object') {\r\n            return false;\r\n          }\r\n          const receiptPayload = message.payload as any;\r\n          if (!receiptPayload.messageId || typeof receiptPayload.messageId !== 'string') {\r\n            return false;\r\n          }\r\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":375,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":375,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11643,11646],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11643,11646],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"no-case-declarations","severity":2,"message":"Unexpected lexical declaration in case block.","line":385,"column":11,"nodeType":"VariableDeclaration","messageId":"unexpected","endLine":385,"endColumn":56,"suggestions":[{"messageId":"addBrackets","fix":{"range":[11842,12233],"text":"{ if (!message.payload || typeof message.payload !== 'object') {\r\n            return false;\r\n          }\r\n          const statusPayload = message.payload as any;\r\n          if (!statusPayload.messageId || typeof statusPayload.messageId !== 'string' ||\r\n              !statusPayload.status || typeof statusPayload.status !== 'string') {\r\n            return false;\r\n          }\r\n          break; }"},"desc":"Add {} brackets around the case block."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":385,"column":52,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":385,"endColumn":55,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[11997,12000],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[11997,12000],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":404,"column":70,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":404,"endColumn":73,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[12618,12621],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[12618,12621],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":3,"fatalErrorCount":0,"warningCount":8,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\r\n * WebSocket Service\r\n *\r\n * Handles real-time communication with the server.\r\n * All messages use a consistent JSON format - never double-encoded.\r\n */\r\n\r\nimport type {\r\n  WSMessage,\r\n  WSMessageType,\r\n  EncryptedPayload,\r\n  TypingPayload,\r\n  ReadReceiptPayload,\r\n  PresencePayload,\r\n  StatusUpdatePayload,\r\n} from '../types';\r\n\r\ntype MessageHandler<T = unknown> = (payload: T, message: WSMessage<T>) => void;\r\n\r\ninterface WebSocketConfig {\r\n  url: string;\r\n  token: string;\r\n  onConnect?: () => void;\r\n  onDisconnect?: () => void;\r\n  onError?: (error: Event) => void;\r\n}\r\n\r\nexport class WebSocketService {\r\n  private ws: WebSocket | null = null;\r\n  private config: WebSocketConfig;\r\n  private handlers = new Map<WSMessageType, Set<MessageHandler>>();\r\n  private reconnectAttempts = 0;\r\n  private maxReconnectAttempts = 5;\r\n  private reconnectDelay = 1000;\r\n  private heartbeatInterval: number | null = null;\r\n  private messageQueue: Array<{ type: WSMessageType; payload: unknown }> = [];\r\n\r\n  constructor(config: WebSocketConfig) {\r\n    this.config = config;\r\n  }\r\n\r\n  /**\r\n   * Connect to the WebSocket server\r\n   */\r\n  connect(): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      // Use Sec-WebSocket-Protocol for auth (works in all browsers)\r\n      this.ws = new WebSocket(this.config.url, ['Bearer', this.config.token]);\r\n\r\n      this.ws.onopen = () => {\r\n        this.reconnectAttempts = 0;\r\n        this.startHeartbeat();\r\n        this.flushMessageQueue();\r\n        this.config.onConnect?.();\r\n        resolve();\r\n      };\r\n\r\n      this.ws.onmessage = (event) => {\r\n        this.handleMessage(event.data);\r\n      };\r\n\r\n      this.ws.onclose = () => {\r\n        this.stopHeartbeat();\r\n        this.config.onDisconnect?.();\r\n        this.attemptReconnect();\r\n      };\r\n\r\n      this.ws.onerror = (error) => {\r\n        this.config.onError?.(error);\r\n        reject(error);\r\n      };\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Disconnect from the WebSocket server\r\n   */\r\n  disconnect(): void {\r\n    this.maxReconnectAttempts = 0; // Prevent auto-reconnect\r\n    this.stopHeartbeat();\r\n    this.ws?.close();\r\n    this.ws = null;\r\n  }\r\n\r\n  /**\r\n   * Subscribe to a message type\r\n   * Returns an unsubscribe function\r\n   */\r\n  on<T>(type: WSMessageType, handler: MessageHandler<T>): () => void {\r\n    if (!this.handlers.has(type)) {\r\n      this.handlers.set(type, new Set());\r\n    }\r\n    this.handlers.get(type)!.add(handler as MessageHandler);\r\n\r\n    return () => {\r\n      this.handlers.get(type)?.delete(handler as MessageHandler);\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Send a message to the server\r\n   * Payload is always an object - never pre-stringify\r\n   */\r\n  async send<T extends object>(type: WSMessageType, payload: T): Promise<void> {\r\n    const message: WSMessage<T> = {\r\n      type,\r\n      payload,\r\n      timestamp: Date.now(),\r\n      messageId: crypto.randomUUID(),\r\n    };\r\n\r\n    // Add HMAC signature for message integrity\r\n    const signature = await this.generateMessageSignature(message);\r\n    const signedMessage = {\r\n      ...message,\r\n      signature,\r\n      nonce: Array.from(crypto.getRandomValues(new Uint8Array(16))), // 128-bit nonce for replay protection\r\n    };\r\n\r\n    if (this.ws?.readyState === WebSocket.OPEN) {\r\n      this.ws.send(JSON.stringify(signedMessage));\r\n    } else {\r\n      // Queue message for when connection is restored\r\n      this.messageQueue.push({ type, payload });\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate HMAC signature for message integrity\r\n   * Uses standardized HMAC key derivation to match backend implementation\r\n   */\r\n  private async generateMessageSignature(message: WSMessage): Promise<string> {\r\n    if (!this.config.token) {\r\n      throw new Error('No authentication token available for message signing');\r\n    }\r\n\r\n    // Create message string for HMAC: type + timestamp + messageId + payload\r\n    const messageStr = `${message.type}:${message.timestamp}:${message.messageId}:${JSON.stringify(message.payload)}`;\r\n\r\n    // Standardized HMAC key derivation to match Go backend:\r\n    // 1. Use full token as key material\r\n    // 2. Pad to 32 bytes if shorter, truncate if longer (match Go behavior)\r\n    const tokenBytes = new TextEncoder().encode(this.config.token);\r\n    let keyData: Uint8Array;\r\n\r\n    if (tokenBytes.length < 32) {\r\n      // Pad to 32 bytes with zeros (match Go padding behavior)\r\n      keyData = new Uint8Array(32);\r\n      keyData.set(tokenBytes);\r\n      // Fill remaining bytes with zeros\r\n      for (let i = tokenBytes.length; i < 32; i++) {\r\n        keyData[i] = 0;\r\n      }\r\n    } else {\r\n      // Truncate to 32 bytes (match Go truncation behavior)\r\n      keyData = tokenBytes.slice(0, 32);\r\n    }\r\n\r\n    const messageData = new TextEncoder().encode(messageStr);\r\n\r\n    // Generate HMAC-SHA256 signature\r\n    return this.hmacSha256(keyData, messageData);\r\n  }\r\n\r\n  /**\r\n   * HMAC-SHA256 implementation using Web Crypto API\r\n   */\r\n  private async hmacSha256(key: Uint8Array, data: Uint8Array): Promise<string> {\r\n    const cryptoKey = await crypto.subtle.importKey(\r\n      'raw',\r\n      key as any,\r\n      { name: 'HMAC', hash: 'SHA-256' },\r\n      false,\r\n      ['sign']\r\n    );\r\n\r\n    const signature = await crypto.subtle.sign('HMAC', cryptoKey, data as any);\r\n    return Array.from(new Uint8Array(signature))\r\n      .map(b => b.toString(16).padStart(2, '0'))\r\n      .join('');\r\n  }\r\n\r\n  /**\r\n   * Send an encrypted message\r\n   */\r\n  async sendEncryptedMessage(payload: EncryptedPayload): Promise<void> {\r\n    await this.send('send', payload);\r\n  }\r\n\r\n  /**\r\n   * Send a sealed sender message\r\n   */\r\n  sendSealedSenderMessage(payload: EncryptedPayload & {\r\n    sealedSenderCertificateId?: string;\r\n    ephemeralPublicKey?: string;\r\n  }): void {\r\n    this.send('send', payload);\r\n  }\r\n\r\n  /**\r\n   * Send typing indicator\r\n   */\r\n  async sendTypingIndicator(recipientId: string, isTyping: boolean): Promise<void> {\r\n    const payload: TypingPayload = { recipientId, isTyping };\r\n    await this.send('typing', payload);\r\n  }\r\n\r\n  /**\r\n   * Send read receipt\r\n   */\r\n  async sendReadReceipt(messageId: string, conversationId: string, status: 'delivered' | 'read'): Promise<void> {\r\n    const payload: ReadReceiptPayload = { messageId, conversationId, status };\r\n    await this.send('read_receipt', payload);\r\n  }\r\n\r\n  /**\r\n   * Check if connected\r\n   */\r\n  isConnected(): boolean {\r\n    return this.ws?.readyState === WebSocket.OPEN;\r\n  }\r\n\r\n  // Private methods\r\n\r\n  private async handleMessage(data: string): Promise<void> {\r\n    try {\r\n      const message: WSMessage = JSON.parse(data);\r\n\r\n      // SECURITY: Validate message signature if present\r\n      if (message.signature && message.nonce) {\r\n        if (!(await this.verifyMessageSignature(message))) {\r\n          console.error('Invalid message signature detected - possible tampering');\r\n          // SECURITY: Disconnect on signature verification failure to prevent MITM attacks\r\n          this.disconnect();\r\n          return;\r\n        }\r\n      }\r\n\r\n      // SECURITY: Validate message structure\r\n      if (!message.type || typeof message.type !== 'string') {\r\n        console.error('Invalid message type');\r\n        return;\r\n      }\r\n\r\n      // SECURITY: Validate payload based on message type\r\n      if (this.isPayloadValidationRequired(message.type) && !this.validatePayload(message)) {\r\n        console.error('Invalid payload for message type:', message.type);\r\n        return;\r\n      }\r\n\r\n      // Dispatch to handlers\r\n      const handlers = this.handlers.get(message.type);\r\n      if (handlers) {\r\n        handlers.forEach((handler) => {\r\n          try {\r\n            handler(message.payload, message);\r\n          } catch (e) {\r\n            console.error(`Error in handler for ${message.type}:`, e);\r\n            // Add recovery mechanism\r\n            this.recoverFromHandlerError(message.type, e);\r\n          }\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.error('Failed to parse WebSocket message:', e);\r\n    }\r\n  }\r\n\r\n  private startHeartbeat(): void {\r\n    this.heartbeatInterval = window.setInterval(() => {\r\n      if (this.ws?.readyState === WebSocket.OPEN) {\r\n        this.send('heartbeat', {});\r\n      }\r\n    }, 30000);\r\n  }\r\n\r\n  private stopHeartbeat(): void {\r\n    if (this.heartbeatInterval) {\r\n      clearInterval(this.heartbeatInterval);\r\n      this.heartbeatInterval = null;\r\n    }\r\n  }\r\n\r\n  private attemptReconnect(): void {\r\n    if (this.reconnectAttempts >= this.maxReconnectAttempts) {\r\n      console.error('Max reconnection attempts reached');\r\n      return;\r\n    }\r\n\r\n    this.reconnectAttempts++;\r\n    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);\r\n\r\n    setTimeout(() => {\r\n      console.log(`Reconnection attempt ${this.reconnectAttempts}...`);\r\n      this.connect().catch(console.error);\r\n    }, delay);\r\n  }\r\n\r\n  private flushMessageQueue(): void {\r\n    while (this.messageQueue.length > 0) {\r\n      const { type, payload } = this.messageQueue.shift()!;\r\n      this.send(type, payload as object);\r\n    }\r\n  }\r\n\r\n  // verifyMessageSignature verifies the HMAC signature of a message\r\n  private async verifyMessageSignature(message: WSMessage): Promise<boolean> {\r\n    if (!message.signature || !message.nonce) {\r\n      return false;\r\n    }\r\n\r\n    if (!this.config.token) {\r\n      console.error('No authentication token available for message verification');\r\n      return false;\r\n    }\r\n\r\n    // Create message string for HMAC: type + timestamp + messageId + payload\r\n    const messageStr = `${message.type}:${message.timestamp}:${message.messageId}:${JSON.stringify(message.payload)}`;\r\n\r\n    // Use token as HMAC key (first 32 bytes for SHA-256)\r\n    const keyData = new TextEncoder().encode(this.config.token).slice(0, 32);\r\n    const messageData = new TextEncoder().encode(messageStr);\r\n\r\n    try {\r\n      // Generate expected HMAC signature\r\n      const cryptoKey = await crypto.subtle.importKey(\r\n        'raw',\r\n        keyData as any,\r\n        { name: 'HMAC', hash: 'SHA-256' },\r\n        false,\r\n        ['sign']\r\n      );\r\n\r\n      const expectedSignature = await crypto.subtle.sign('HMAC', cryptoKey, messageData as any);\r\n      const expectedHex = Array.from(new Uint8Array(expectedSignature))\r\n        .map(b => b.toString(16).padStart(2, '0'))\r\n        .join('');\r\n\r\n      // Compare signatures\r\n      return expectedHex === message.signature;\r\n    } catch (error) {\r\n      console.error('Error verifying message signature:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // isPayloadValidationRequired checks if payload validation is needed for this message type\r\n  private isPayloadValidationRequired(messageType: WSMessageType): boolean {\r\n    const validationRequiredTypes: WSMessageType[] = [\r\n      'send', 'deliver', 'read_receipt', 'status_update'\r\n    ];\r\n    return validationRequiredTypes.includes(messageType);\r\n  }\r\n\r\n  // validatePayload validates the payload structure based on message type\r\n  private validatePayload(message: WSMessage): boolean {\r\n    try {\r\n      switch (message.type) {\r\n        case 'send':\r\n        case 'deliver':\r\n          // Validate encrypted payload structure\r\n          if (!message.payload || typeof message.payload !== 'object') {\r\n            return false;\r\n          }\r\n          const msgPayload = message.payload as any;\r\n          if (!msgPayload.ciphertext || typeof msgPayload.ciphertext !== 'string') {\r\n            return false;\r\n          }\r\n          break;\r\n\r\n        case 'read_receipt':\r\n          if (!message.payload || typeof message.payload !== 'object') {\r\n            return false;\r\n          }\r\n          const receiptPayload = message.payload as any;\r\n          if (!receiptPayload.messageId || typeof receiptPayload.messageId !== 'string') {\r\n            return false;\r\n          }\r\n          break;\r\n\r\n        case 'status_update':\r\n          if (!message.payload || typeof message.payload !== 'object') {\r\n            return false;\r\n          }\r\n          const statusPayload = message.payload as any;\r\n          if (!statusPayload.messageId || typeof statusPayload.messageId !== 'string' ||\r\n              !statusPayload.status || typeof statusPayload.status !== 'string') {\r\n            return false;\r\n          }\r\n          break;\r\n\r\n        default:\r\n          // Other message types don't require strict validation\r\n          return true;\r\n      }\r\n      return true;\r\n    } catch (e) {\r\n      console.error('Payload validation error:', e);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  // recoverFromHandlerError handles errors from message handlers\r\n  private recoverFromHandlerError(messageType: WSMessageType, error: any): void {\r\n    console.error(`Recovering from handler error for ${messageType}:`, error);\r\n\r\n    // Implement recovery strategies based on message type\r\n    switch (messageType) {\r\n      case 'send':\r\n      case 'deliver':\r\n        // For message delivery errors, we might want to retry or notify the user\r\n        break;\r\n\r\n      case 'read_receipt':\r\n        // Read receipt errors are less critical, just log them\r\n        break;\r\n\r\n      default:\r\n        // Generic recovery for other message types\r\n        break;\r\n    }\r\n  }\r\n}\r\n\r\n// Type-safe event handlers\r\nexport interface WebSocketEventHandlers {\r\n  onMessage: (payload: EncryptedPayload, message: WSMessage<EncryptedPayload>) => void;\r\n  onTyping: (payload: TypingPayload) => void;\r\n  onReadReceipt: (payload: ReadReceiptPayload) => void;\r\n  onPresence: (payload: PresencePayload) => void;\r\n  onStatusUpdate: (payload: StatusUpdatePayload) => void;\r\n}\r\n\r\n/**\r\n * Create a WebSocket service with type-safe handlers\r\n */\r\nexport function createWebSocketService(\r\n  config: WebSocketConfig,\r\n  handlers: Partial<WebSocketEventHandlers>\r\n): WebSocketService {\r\n  const service = new WebSocketService(config);\r\n\r\n  if (handlers.onMessage) {\r\n    service.on('deliver', handlers.onMessage);\r\n  }\r\n  if (handlers.onTyping) {\r\n    service.on('typing', handlers.onTyping);\r\n  }\r\n  if (handlers.onReadReceipt) {\r\n    service.on('read_receipt', handlers.onReadReceipt);\r\n  }\r\n  if (handlers.onPresence) {\r\n    service.on('user_online', (payload: PresencePayload) => handlers.onPresence!(payload));\r\n    service.on('user_offline', (payload: PresencePayload) => handlers.onPresence!(payload));\r\n  }\r\n  if (handlers.onStatusUpdate) {\r\n    service.on('status_update', handlers.onStatusUpdate);\r\n  }\r\n\r\n  return service;\r\n}\r\n\r\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\store\\authStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\store\\callStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\store\\chatStore.test.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\store\\chatStore.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'_' is assigned a value but never used.","line":134,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":134,"endColumn":26},{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'__' is assigned a value but never used.","line":135,"column":25,"nodeType":null,"messageId":"unusedVar","endLine":135,"endColumn":27}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { create } from 'zustand';\nimport { persist } from 'zustand/middleware';\nimport type { Conversation, Message, MessageStatus } from '../types';\nimport { encryptChatData, decryptChatData } from '../crypto/storage';\n\ninterface ChatState {\n  conversations: Record<string, Conversation>;\n  messages: Record<string, Message[]>;\n  activeConversationId: string | null;\n  presenceCache: Record<string, { isOnline: boolean; lastSeen?: number }>;\n}\n\ninterface ChatActions {\n  // Conversation actions\n  setActiveConversation: (id: string | null) => void;\n  addConversation: (conversation: Conversation) => void;\n  updateConversation: (id: string, updates: Partial<Conversation>) => void;\n  removeConversation: (id: string) => void;\n\n  // Message actions\n  addMessage: (message: Message) => void;\n  addMessageOptimistically: (message: Message) => string; // Returns temp ID\n  confirmMessage: (tempId: string, realId: string) => void; // Update temp ID to real ID\n  failMessage: (tempId: string) => void; // Remove failed optimistic message\n  updateMessage: (messageId: string, updates: Partial<Message>) => void;\n  updateMessageStatus: (messageId: string, status: MessageStatus) => void;\n  setMessages: (conversationId: string, messages: Message[]) => void;\n\n  // Presence actions\n  updatePresence: (userId: string, isOnline: boolean, lastSeen?: number) => void;\n  syncPresenceToConversations: () => void;\n\n  // Utility actions\n  markConversationRead: (conversationId: string) => void;\n  clearAll: () => void;\n}\n\ntype ChatStore = ChatState & ChatActions;\n\n// Custom storage with encryption support\nconst encryptedStorage = {\n  getItem: async (key: string) => {\n    try {\n      const stored = localStorage.getItem(key);\n      if (!stored) return null;\n\n      // Check if data is encrypted (contains ':')\n      if (stored.includes(':')) {\n        try {\n          const decrypted = await decryptChatData(stored);\n          return { state: decrypted };\n        } catch (error) {\n          console.error('SECURITY: Failed to decrypt chat data - potential data corruption or tampering:', error);\n          // If decryption fails, clear the corrupted data and return null\n          // This prevents using potentially compromised data\n          localStorage.removeItem(key);\n          return null;\n        }\n      } else {\n        // SECURITY: If we encounter unencrypted data, it should be migrated to encrypted format\n        // For now, we'll return it but log a security warning\n        console.warn('SECURITY: Found unencrypted chat data - this should be migrated to encrypted format');\n        return { state: JSON.parse(stored) };\n      }\n    } catch (error) {\n      console.error('SECURITY: Error reading from encrypted storage:', error);\n      return null;\n    }\n  },\n  setItem: async (key: string, value: { state: Partial<ChatStore>; version?: number }): Promise<void> => {\n    try {\n      // SECURITY: Always attempt encryption first\n      try {\n        const encrypted = await encryptChatData(value.state);\n        localStorage.setItem(key, encrypted);\n        console.log('SECURITY: Chat data successfully encrypted and stored');\n      } catch (error) {\n        console.error('SECURITY CRITICAL: Encryption failed - this should not happen in production:', error);\n        // SECURITY: We should NOT fall back to unencrypted storage\n        // This would be a critical security failure\n        throw new Error('SECURITY CRITICAL: Cannot store unencrypted chat data');\n      }\n    } catch (error) {\n      console.error('SECURITY: Error writing to encrypted storage:', error);\n      throw new Error('SECURITY CRITICAL: Cannot store unencrypted chat data');\n    }\n  },\n  removeItem: (key: string): void => {\n    // SECURITY: Ensure data is properly removed\n    try {\n      localStorage.removeItem(key);\n      console.log('SECURITY: Chat data successfully removed from storage');\n    } catch (error) {\n      console.error('SECURITY: Failed to remove chat data from storage:', error);\n      throw new Error('Failed to remove chat data');\n    }\n  },\n};\n\nexport const useChatStore = create<ChatStore>()(\n  persist(\n    (set, get) => ({\n      // Initial state\n      conversations: {},\n      messages: {},\n      activeConversationId: null,\n      presenceCache: {},\n\n      // Conversation actions\n      setActiveConversation: (id) => set({ activeConversationId: id }),\n\n      addConversation: (conversation) =>\n        set((state) => ({\n          conversations: {\n            ...state.conversations,\n            [conversation.id]: conversation,\n          },\n        })),\n\n      updateConversation: (id, updates) =>\n        set((state) => {\n          const existing = state.conversations[id];\n          if (!existing) return state;\n          return {\n            conversations: {\n              ...state.conversations,\n              [id]: { ...existing, ...updates },\n            },\n          };\n        }),\n\n      removeConversation: (id) =>\n        set((state) => {\n          const { [id]: _, ...rest } = state.conversations;\n          const { [id]: __, ...restMessages } = state.messages;\n          return {\n            conversations: rest,\n            messages: restMessages,\n            activeConversationId:\n              state.activeConversationId === id ? null : state.activeConversationId,\n          };\n        }),\n\n      // Message actions\n      addMessage: (message) =>\n        set((state) => {\n          const conversationMessages = state.messages[message.conversationId] || [];\n\n          // Check for duplicate\n          if (conversationMessages.some((m) => m.id === message.id)) {\n            return state;\n          }\n\n          // Update conversation's last message\n          const conversation = state.conversations[message.conversationId];\n          const updatedConversation = conversation\n            ? {\n                ...conversation,\n                lastMessage: message,\n                unreadCount:\n                  state.activeConversationId !== message.conversationId &&\n                  message.senderId !== 'self'\n                    ? conversation.unreadCount + 1\n                    : conversation.unreadCount,\n              }\n            : null;\n\n          return {\n            messages: {\n              ...state.messages,\n              [message.conversationId]: [...conversationMessages, message],\n            },\n            conversations: updatedConversation\n              ? {\n                  ...state.conversations,\n                  [message.conversationId]: updatedConversation,\n                }\n              : state.conversations,\n          };\n        }),\n\n      addMessageOptimistically: (message) => {\n        const tempId = `temp-${Date.now()}-${Math.random()}`;\n        const optimisticMessage = { ...message, id: tempId, status: 'sending' as MessageStatus };\n\n        get().addMessage(optimisticMessage);\n        return tempId;\n      },\n\n      confirmMessage: (tempId, realId) =>\n        set((state) => {\n          const newMessages = { ...state.messages };\n          for (const convId of Object.keys(newMessages)) {\n            const idx = newMessages[convId].findIndex((m) => m.id === tempId);\n            if (idx !== -1) {\n              newMessages[convId] = [...newMessages[convId]];\n              newMessages[convId][idx] = {\n                ...newMessages[convId][idx],\n                id: realId,\n                status: 'sent' as MessageStatus\n              };\n              break;\n            }\n          }\n          return { messages: newMessages };\n        }),\n\n      failMessage: (tempId) =>\n        set((state) => {\n          const newMessages = { ...state.messages };\n          for (const convId of Object.keys(newMessages)) {\n            newMessages[convId] = newMessages[convId].filter((m) => m.id !== tempId);\n          }\n          return { messages: newMessages };\n        }),\n\n      updateMessage: (messageId, updates) =>\n        set((state) => {\n          const newMessages = { ...state.messages };\n          for (const convId of Object.keys(newMessages)) {\n            const idx = newMessages[convId].findIndex((m) => m.id === messageId);\n            if (idx !== -1) {\n              newMessages[convId] = [...newMessages[convId]];\n              newMessages[convId][idx] = { ...newMessages[convId][idx], ...updates };\n              break;\n            }\n          }\n          return { messages: newMessages };\n        }),\n\n      updateMessageStatus: (messageId, status) =>\n        get().updateMessage(messageId, { status }),\n\n      setMessages: (conversationId, messages) =>\n        set((state) => ({\n          messages: {\n            ...state.messages,\n            [conversationId]: messages,\n          },\n        })),\n\n      // Presence actions\n      updatePresence: (userId, isOnline, lastSeen) =>\n        set((state) => {\n          // Update presence cache\n          const newPresenceCache = {\n            ...state.presenceCache,\n            [userId]: { isOnline, lastSeen: lastSeen || state.presenceCache[userId]?.lastSeen },\n          };\n\n          // Update matching conversations\n          const newConversations = { ...state.conversations };\n          for (const convId of Object.keys(newConversations)) {\n            if (newConversations[convId].recipientId === userId) {\n              newConversations[convId] = {\n                ...newConversations[convId],\n                isOnline,\n                lastSeen: lastSeen || newConversations[convId].lastSeen,\n              };\n            }\n          }\n\n          return {\n            presenceCache: newPresenceCache,\n            conversations: newConversations,\n          };\n        }),\n\n      syncPresenceToConversations: () =>\n        set((state) => {\n          const newConversations = { ...state.conversations };\n          for (const convId of Object.keys(newConversations)) {\n            const recipientId = newConversations[convId].recipientId;\n            const presence = state.presenceCache[recipientId];\n            if (presence) {\n              newConversations[convId] = {\n                ...newConversations[convId],\n                isOnline: presence.isOnline,\n                lastSeen: presence.lastSeen,\n              };\n            }\n          }\n          return { conversations: newConversations };\n        }),\n\n      // Utility actions\n      markConversationRead: (conversationId) =>\n        set((state) => {\n          const conversation = state.conversations[conversationId];\n          if (!conversation) return state;\n          return {\n            conversations: {\n              ...state.conversations,\n              [conversationId]: { ...conversation, unreadCount: 0 },\n            },\n          };\n        }),\n\n      clearAll: () =>\n        set({\n          conversations: {},\n          messages: {},\n          activeConversationId: null,\n          presenceCache: {},\n        }),\n    }),\n    {\n      name: 'chat-storage',\n      storage: encryptedStorage,\n      partialize: (state) => ({\n        conversations: state.conversations,\n        messages: state.messages,\n        presenceCache: state.presenceCache,\n      }),\n    }\n  )\n);\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\store\\settingsStore.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\types\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\utils\\cookies.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\utils\\logger.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":10,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":10,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[245,248],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[245,248],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":20,"column":36,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":20,"endColumn":39,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[517,520],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[517,520],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":30,"column":34,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":30,"endColumn":37,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[802,805],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[802,805],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":3,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Security-focused logger for sanitization and security operations\n */\nexport const logger = {\n  /**\n   * Log security warnings\n   * @param message - Warning message\n   * @param data - Additional data\n   */\n  warn: (message: string, data?: any) => {\n    console.warn(`[SECURITY] ${message}`, data);\n    // In production, this would also send to security monitoring\n  },\n\n  /**\n   * Log security errors\n   * @param message - Error message\n   * @param error - Error object\n   */\n  error: (message: string, error?: any) => {\n    console.error(`[SECURITY] ${message}`, error);\n    // In production, this would also send to security monitoring\n  },\n\n  /**\n   * Log security information\n   * @param message - Information message\n   * @param data - Additional data\n   */\n  info: (message: string, data?: any) => {\n    console.info(`[SECURITY] ${message}`, data);\n  }\n};","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\utils\\sanitization.test.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":1,"message":"'logger' is defined but never used.","line":3,"column":10,"nodeType":null,"messageId":"unusedVar","endLine":3,"endColumn":16},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":44,"column":53,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":44,"endColumn":56,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[1593,1596],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[1593,1596],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":80,"column":41,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":80,"endColumn":44,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2875,2878],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2875,2878],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":107,"column":47,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":107,"endColumn":50,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[3774,3777],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[3774,3777],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":127,"column":50,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":127,"endColumn":53,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[4493,4496],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[4493,4496],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":5,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { describe, it, expect, vi } from 'vitest';\nimport { sanitizeMessageContent, isSafeThumbnailUrl, sanitizeFileName, sanitizeUserContent } from './sanitization';\nimport { logger } from './logger';\n\n// Mock logger\nvi.mock('./logger', () => ({\n  logger: {\n    warn: vi.fn(),\n    error: vi.fn(),\n    info: vi.fn()\n  }\n}));\n\ndescribe('Sanitization Utilities - Security Tests', () => {\n  describe('sanitizeMessageContent', () => {\n    it('should sanitize basic XSS attempts', () => {\n      const malicious = '<script>alert(\"XSS\")</script>';\n      const result = sanitizeMessageContent(malicious);\n      expect(result).not.toContain('<script>');\n      expect(result).not.toContain('alert');\n    });\n\n    it('should block script injection patterns', () => {\n      const malicious = 'Hello <img src=\"x\" onerror=\"alert(1)\">';\n      const result = sanitizeMessageContent(malicious);\n      expect(result).not.toContain('onerror');\n      expect(result).not.toContain('alert');\n    });\n\n    it('should handle javascript: URLs', () => {\n      const malicious = '<a href=\"javascript:alert(1)\">Click</a>';\n      const result = sanitizeMessageContent(malicious);\n      expect(result).not.toContain('javascript:');\n    });\n\n    it('should allow safe formatting tags', () => {\n      const safe = 'Hello <b>world</b> and <i>friends</i>';\n      const result = sanitizeMessageContent(safe);\n      expect(result).toContain('<b>world</b>');\n      expect(result).toContain('<i>friends</i>');\n    });\n\n    it('should handle non-string input gracefully', () => {\n      const result = sanitizeMessageContent(null as any);\n      expect(result).toBe('');\n    });\n\n    it('should detect and block malicious patterns', () => {\n      const malicious = 'Hello <script>alert(1)</script> world';\n      const result = sanitizeMessageContent(malicious);\n      expect(result).not.toContain('<script>');\n    });\n  });\n\n  describe('isSafeThumbnailUrl', () => {\n    it('should allow data image URLs', () => {\n      const safeUrl = 'data:image/png;base64,abc123';\n      expect(isSafeThumbnailUrl(safeUrl)).toBe(true);\n    });\n\n    it('should block javascript: URLs', () => {\n      const maliciousUrl = 'javascript:alert(1)';\n      expect(isSafeThumbnailUrl(maliciousUrl)).toBe(false);\n    });\n\n    it('should validate HTTPS URLs with domain restrictions', () => {\n      const safeUrl = 'https://cdn.silentrelay.com/image.jpg';\n      const maliciousUrl = 'https://evil.com/malicious.js';\n\n      expect(isSafeThumbnailUrl(safeUrl)).toBe(true);\n      expect(isSafeThumbnailUrl(maliciousUrl)).toBe(false);\n    });\n\n    it('should block URLs with malicious extensions', () => {\n      const maliciousUrl = 'https://cdn.silentrelay.com/malicious.js';\n      expect(isSafeThumbnailUrl(maliciousUrl)).toBe(false);\n    });\n\n    it('should handle non-string input gracefully', () => {\n      expect(isSafeThumbnailUrl(null as any)).toBe(false);\n    });\n  });\n\n  describe('sanitizeFileName', () => {\n    it('should remove path traversal characters', () => {\n      const malicious = '../../malicious.js';\n      const result = sanitizeFileName(malicious);\n      expect(result).not.toContain('..');\n      expect(result).not.toContain('/');\n      expect(result).not.toContain('\\\\');\n    });\n\n    it('should handle safe file names', () => {\n      const safe = 'document.pdf';\n      const result = sanitizeFileName(safe);\n      expect(result).toBe('document.pdf');\n    });\n\n    it('should sanitize file names with special characters', () => {\n      const malicious = 'malicious<>.js';\n      const result = sanitizeFileName(malicious);\n      expect(result).not.toContain('<');\n      expect(result).not.toContain('>');\n    });\n\n    it('should handle non-string input gracefully', () => {\n      const result = sanitizeFileName(null as any);\n      expect(result).toBe('');\n    });\n  });\n\n  describe('sanitizeUserContent', () => {\n    it('should sanitize user-generated content strictly', () => {\n      const malicious = '<script>alert(1)</script><b>Hello</b>';\n      const result = sanitizeUserContent(malicious);\n      expect(result).not.toContain('<script>');\n      expect(result).toContain('<b>Hello</b>');\n    });\n\n    it('should handle XSS in user content', () => {\n      const malicious = 'Hello <img src=\"x\" onerror=\"alert(1)\">';\n      const result = sanitizeUserContent(malicious);\n      expect(result).not.toContain('onerror');\n    });\n\n    it('should handle non-string input gracefully', () => {\n      const result = sanitizeUserContent(null as any);\n      expect(result).toBe('');\n    });\n  });\n\n  describe('Security Integration Tests', () => {\n    it('should handle complex XSS payloads', () => {\n      const complexPayload = `\n        <script>alert(1)</script>\n        <img src=\"x\" onerror=\"alert(2)\">\n        <svg onload=\"alert(3)\">\n        <a href=\"javascript:alert(4)\">Click</a>\n      `;\n      const result = sanitizeMessageContent(complexPayload);\n      expect(result).not.toContain('<script>');\n      expect(result).not.toContain('onerror');\n      expect(result).not.toContain('onload');\n      expect(result).not.toContain('javascript:');\n    });\n\n    it('should maintain security with edge cases', () => {\n      const edgeCases = [\n        { input: '', expected: '' },\n        { input: '   ', expected: '   ' },\n        { input: '<b>Hello</b>', expected: '<b>Hello</b>' },\n        { input: 'Hello & goodbye', expected: 'Hello & goodbye' }\n      ];\n\n      edgeCases.forEach(({ input, expected }) => {\n        const result = sanitizeMessageContent(input);\n        expect(result).toBe(expected);\n      });\n    });\n  });\n});","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\core\\utils\\sanitization.ts","messages":[{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\-.","line":32,"column":77,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":32,"endColumn":78,"suggestions":[{"messageId":"removeEscape","fix":{"range":[1310,1311],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[1310,1310],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":76,"column":22,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":76,"endColumn":23,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2451,2452],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2451,2451],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":76,"column":32,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":76,"endColumn":33,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2461,2462],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2461,2461],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":77,"column":11,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":77,"endColumn":12,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2558,2559],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2558,2558],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]},{"ruleId":"no-useless-escape","severity":2,"message":"Unnecessary escape character: \\/.","line":77,"column":21,"nodeType":"Literal","messageId":"unnecessaryEscape","endLine":77,"endColumn":22,"suggestions":[{"messageId":"removeEscape","fix":{"range":[2568,2569],"text":""},"desc":"Remove the `\\`. This maintains the current functionality."},{"messageId":"escapeBackslash","fix":{"range":[2568,2568],"text":"\\"},"desc":"Replace the `\\` with `\\\\` to include the actual backslash character."}]}],"suppressedMessages":[],"errorCount":5,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import DOMPurify from 'dompurify';\nimport { logger } from './logger';\n\n/**\n * Enhanced message content sanitization with comprehensive XSS protection\n * @param content - Raw message content to sanitize\n * @returns Sanitized content safe for rendering\n */\nexport function sanitizeMessageContent(content: string): string {\n  try {\n    // Validate input\n    if (typeof content !== 'string') {\n      logger.warn('sanitizeMessageContent: Invalid input type, converting to string');\n      content = String(content);\n    }\n\n    // Enhanced DOMPurify configuration with comprehensive XSS protection\n    const sanitized = DOMPurify.sanitize(content, {\n      ALLOWED_TAGS: ['b', 'i', 'strong', 'em', 'u', 's', 'br', 'p', 'span'],\n      ALLOWED_ATTR: ['class', 'style'],\n      FORBID_TAGS: ['script', 'iframe', 'frame', 'object', 'embed', 'applet', 'link', 'meta'],\n      FORBID_ATTR: ['onerror', 'onclick', 'onload', 'onmouseover', 'style', 'href', 'src'],\n      ADD_URI_SAFE_ATTR: ['href', 'src'],\n      SANITIZE_DOM: true,\n      WHOLE_DOCUMENT: true,\n      RETURN_DOM: false,\n      RETURN_DOM_FRAGMENT: false,\n      RETURN_TRUSTED_TYPE: false,\n      ALLOW_UNKNOWN_PROTOCOLS: false,\n      ALLOW_DATA_ATTR: false,\n      ALLOW_ARIA_ATTR: false,\n      ALLOWED_URI_REGEXP: /^(?:(?:https?|mailto|ftp|tel|data):|[^a-z]|[a-z+.\\-]+(?:[^a-z+.\\-:]|$))/i\n    });\n\n    // Additional security checks\n    if (containsMaliciousPatterns(sanitized)) {\n      logger.warn('sanitizeMessageContent: Detected malicious patterns after sanitization, returning empty string');\n      return '';\n    }\n\n    return sanitized;\n  } catch (error) {\n    logger.error('sanitizeMessageContent: Sanitization failed', error);\n    // Fallback to strict sanitization\n    return DOMPurify.sanitize(content, {\n      ALLOWED_TAGS: [],\n      ALLOWED_ATTR: []\n    });\n  }\n}\n\n/**\n * Check for malicious patterns that might bypass DOMPurify\n * @param content - Content to check\n * @returns True if malicious patterns detected\n */\nfunction containsMaliciousPatterns(content: string): boolean {\n  const maliciousPatterns = [\n    // Script injection patterns\n    /<script[\\s\\S]*?>/i,\n    /javascript:/i,\n    /on\\w+\\s*=/i,\n    /expression\\s*\\(/i,\n    /vbscript:/i,\n    /data:text\\/html/i,\n\n    // Common XSS patterns\n    /&#x?[0-9a-f]+;/i,\n    /document\\.cookie/i,\n    /window\\.location/i,\n    /eval\\s*\\(/i,\n    /setTimeout\\s*\\(/i,\n    /setInterval\\s*\\(/i,\n\n    // Malicious URL patterns\n    /https?:\\/\\/(?:[^\\/]+\\.)?[^\\/]+\\.(?:js|php|asp|aspx|jsp|cfm|pl|py|rb|sh|exe|dll|bat|cmd|vbs|ps1|msi)(?:\\?|#|$)/i,\n    /(?:[^\\/]+\\.)?[^\\/]+\\.(?:js|php|asp|aspx|jsp|cfm|pl|py|rb|sh|exe|dll|bat|cmd|vbs|ps1|msi)(?:\\?|#|$)/i\n  ];\n\n  return maliciousPatterns.some(pattern => pattern.test(content));\n}\n\n/**\n * Enhanced URL validation for thumbnail URLs with security checks\n * @param url - URL to validate\n * @returns True if URL is safe for rendering\n */\nexport function isSafeThumbnailUrl(url: string): boolean {\n  if (typeof url !== 'string') {\n    logger.warn('isSafeThumbnailUrl: Invalid URL type');\n    return false;\n  }\n\n  try {\n    // Check for data URIs with image content\n    if (url.startsWith('data:image/')) {\n      return true;\n    }\n\n    // Check for HTTPS URLs with proper domain validation\n    if (url.startsWith('https://')) {\n      const parsedUrl = new URL(url);\n\n      // Validate domain and path\n      const allowedDomains = ['cdn.silentrelay.com', 'media.silentrelay.com', 'assets.silentrelay.com'];\n      const isAllowedDomain = allowedDomains.includes(parsedUrl.hostname);\n\n      // Check for malicious file extensions\n      const maliciousExtensions = ['.js', '.php', '.asp', '.aspx', '.jsp', '.cfm', '.pl', '.py', '.rb', '.sh', '.exe', '.dll', '.bat', '.cmd', '.vbs', '.ps1', '.msi'];\n      const hasMaliciousExtension = maliciousExtensions.some(ext =>\n        parsedUrl.pathname.toLowerCase().endsWith(ext)\n      );\n\n      return isAllowedDomain && !hasMaliciousExtension;\n    }\n\n    return false;\n  } catch (error) {\n    logger.error('isSafeThumbnailUrl: URL validation failed', error);\n    return false;\n  }\n}\n\n/**\n * Sanitize file names to prevent path traversal and XSS\n * @param fileName - File name to sanitize\n * @returns Sanitized file name\n */\nexport function sanitizeFileName(fileName: string): string {\n  if (typeof fileName !== 'string') {\n    logger.warn('sanitizeFileName: Invalid file name type, returning empty string');\n    return '';\n  }\n\n  // Remove path traversal characters\n  const sanitized = fileName\n    .replace(/[\\\\/:*?\"<>|]/g, '_')\n    .replace(/^\\.+/, '')\n    .replace(/\\.+$/, '')\n    .trim();\n\n  // Additional security check\n  if (containsMaliciousPatterns(sanitized)) {\n    logger.warn('sanitizeFileName: Detected malicious patterns in file name');\n    return 'sanitized_file';\n  }\n\n  return sanitized;\n}\n\n/**\n * Sanitize user-generated content for display in UI elements\n * @param content - Content to sanitize\n * @returns Sanitized content safe for UI display\n */\nexport function sanitizeUserContent(content: string): string {\n  try {\n    if (typeof content !== 'string') {\n      logger.warn('sanitizeUserContent: Invalid content type, converting to string');\n      content = String(content);\n    }\n\n    // Strict sanitization for user-generated content\n    return DOMPurify.sanitize(content, {\n      ALLOWED_TAGS: ['b', 'i', 'strong', 'em'],\n      ALLOWED_ATTR: [],\n      FORBID_TAGS: ['script', 'iframe', 'frame', 'object', 'embed', 'applet', 'link', 'meta'],\n      FORBID_ATTR: ['onerror', 'onclick', 'onload', 'onmouseover', 'style', 'href', 'src'],\n      SANITIZE_DOM: true,\n      WHOLE_DOCUMENT: true,\n      RETURN_TRUSTED_TYPE: false\n    });\n  } catch (error) {\n    logger.error('sanitizeUserContent: Sanitization failed', error);\n    return '';\n  }\n}","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\hooks\\index.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\hooks\\useAuth.ts","messages":[{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":96,"column":64,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":96,"endColumn":67,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[2974,2977],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[2974,2977],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]},{"ruleId":"@typescript-eslint/no-explicit-any","severity":1,"message":"Unexpected any. Specify a different type.","line":164,"column":68,"nodeType":"TSAnyKeyword","messageId":"unexpectedAny","endLine":164,"endColumn":71,"suggestions":[{"messageId":"suggestUnknown","fix":{"range":[5374,5377],"text":"unknown"},"desc":"Use `unknown` instead, this will force you to explicitly, and safely assert the type is correct."},{"messageId":"suggestNever","fix":{"range":[5374,5377],"text":"never"},"desc":"Use `never` instead, this is useful when instantiating generic type parameters that you don't need to know the type of."}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":2,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Auth Hook\n *\n * Provides authentication methods with Signal Protocol\n * key generation during registration.\n */\n\nimport { useState, useCallback, useRef } from 'react';\nimport { useNavigate } from 'react-router-dom';\nimport { useAuthStore } from '@/core/store/authStore';\nimport { useChatStore } from '@/core/store/chatStore';\nimport { signalProtocol } from '@/core/crypto/signal';\nimport { auth } from '@/core/api/client';\n\ninterface AuthError {\n  message: string;\n  code?: string;\n}\n\n// Helper to convert Uint8Array to base64 string\nfunction uint8ArrayToBase64(bytes: Uint8Array): string {\n  let binary = '';\n  for (let i = 0; i < bytes.length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return btoa(binary);\n}\n\n// Generate a UUID v4\nfunction generateUUID(): string {\n  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n    const r = Math.random() * 16 | 0;\n    const v = c === 'x' ? r : (r & 0x3 | 0x8);\n    return v.toString(16);\n  });\n}\n\nexport function useAuth() {\n  const [isLoading, setIsLoading] = useState(false);\n  const [error, setError] = useState<AuthError | null>(null);\n  const navigate = useNavigate();\n\n  const { setAuth, logout: storeLogout, isAuthenticated } = useAuthStore();\n  const { clearAll: clearChat } = useChatStore();\n\n  // Dev mode code (only populated in development)\n  const [devCode, setDevCode] = useState<string | null>(null);\n\n  // Store the verification code for use during registration\n  const verificationCodeRef = useRef<string>('');\n\n  // Send verification code\n  const sendCode = useCallback(async (phoneNumber: string): Promise<boolean> => {\n    setIsLoading(true);\n    setError(null);\n    setDevCode(null);\n\n    try {\n      const result = await auth.sendCode(phoneNumber);\n      // In dev mode, the server returns the code\n      if (result.code) {\n        setDevCode(result.code);\n      }\n      return true;\n    } catch (err) {\n      setError({\n        message: err instanceof Error ? err.message : 'Failed to send verification code',\n      });\n      return false;\n    } finally {\n      setIsLoading(false);\n    }\n  }, []);\n\n  // Verify code\n  const verifyCode = useCallback(\n    async (phoneNumber: string, code: string): Promise<{ isNewUser: boolean } | null> => {\n      setIsLoading(true);\n      setError(null);\n\n      try {\n        const result = await auth.verifyCode(phoneNumber, code);\n\n        // user_exists: true means existing user, false means new user\n        const isNewUser = !result.user_exists;\n\n        if (result.user_exists && result.token && result.user && result.device_id) {\n          // Existing user - log them in with full user data\n          const user = {\n            id: result.user.id,\n            phoneNumber: result.user.phone_number,\n            username: result.user.username,\n            displayName: result.user.display_name,\n            avatar: result.user.avatar_url,\n          };\n          setAuth(result.token, result.refresh_token!, user as any, result.device_id);\n          navigate('/chat');\n        } else {\n          // Store the code for registration\n          verificationCodeRef.current = code;\n        }\n\n        return { isNewUser };\n      } catch (err) {\n        setError({\n          message: err instanceof Error ? err.message : 'Invalid verification code',\n        });\n        return null;\n      } finally {\n        setIsLoading(false);\n      }\n    },\n    [setAuth, navigate]\n  );\n\n  // Complete registration with Signal Protocol keys\n  const register = useCallback(\n    async (phoneNumber: string): Promise<boolean> => {\n      setIsLoading(true);\n      setError(null);\n\n      try {\n        // Initialize Signal Protocol\n        await signalProtocol.initialize();\n\n        // Generate identity keys\n        const identityKeyPair = await signalProtocol.generateIdentityKeyPair();\n        const signedPreKey = await signalProtocol.generateSignedPreKey(1);\n        const preKeys = await signalProtocol.generatePreKeys(1, 100);\n\n        // Generate device ID and device key\n        const deviceId = generateUUID();\n        const deviceKeyPair = await signalProtocol.generateIdentityKeyPair(); // Use as device key\n\n        // Convert keys to base64 strings\n        const publicIdentityKey = uint8ArrayToBase64(identityKeyPair.publicKey);\n        const publicSignedPrekey = uint8ArrayToBase64(signedPreKey.publicKey);\n        const signedPrekeySignature = uint8ArrayToBase64(signedPreKey.signature);\n        const publicDeviceKey = uint8ArrayToBase64(deviceKeyPair.publicKey);\n\n        // Register with server\n        const result = await auth.register({\n          phoneNumber,\n          code: verificationCodeRef.current,\n          publicIdentityKey,\n          publicSignedPrekey,\n          signedPrekeySignature,\n          preKeys: preKeys.map((pk) => ({\n            prekeyId: pk.keyId,\n            publicKey: uint8ArrayToBase64(pk.publicKey),\n          })),\n          deviceId,\n          deviceType: 'web',\n          publicDeviceKey,\n        });\n\n        // Set auth state - convert snake_case response to camelCase\n        const user = {\n          id: result.user.user_id,\n          phoneNumber: result.user.phone_number,\n        };\n        // Pass true for isNewUser to trigger onboarding\n        // Note: deviceId is generated locally, not returned from server\n        setAuth(result.access_token, result.refresh_token, user as any, deviceId, true);\n        navigate('/chat');\n\n        return true;\n      } catch (err) {\n        setError({\n          message: err instanceof Error ? err.message : 'Failed to complete registration',\n        });\n        return false;\n      } finally {\n        setIsLoading(false);\n      }\n    },\n    [setAuth, navigate]\n  );\n\n  // Logout\n  const logout = useCallback(async () => {\n    try {\n      await auth.logout();\n    } catch {\n      // Ignore logout errors\n    } finally {\n      storeLogout();\n      clearChat();\n      navigate('/');\n    }\n  }, [storeLogout, clearChat, navigate]);\n\n  return {\n    isLoading,\n    error,\n    isAuthenticated,\n    devCode,\n    sendCode,\n    verifyCode,\n    register,\n    logout,\n    clearError: () => setError(null),\n  };\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\hooks\\useMobileNavigation.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\hooks\\useSwipeGesture.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\hooks\\useViewport.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\hooks\\useWebSocket.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\lib\\errors.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\lib\\phoneNumber.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\lib\\utils.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\main.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\pages\\Auth.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\pages\\Chat.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"The 'activeMessages' conditional could make the dependencies of useEffect Hook (at line 133) change on every render. To fix this, wrap the initialization of 'activeMessages' in its own useMemo() Hook.","line":121,"column":9,"nodeType":"VariableDeclarator","endLine":121,"endColumn":90}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"/**\n * Chat Page\n *\n * Mobile-first responsive messaging interface with:\n * - Dual-panel navigation (list/chat panels)\n * - Animated slide transitions on mobile\n * - Side-by-side split view on tablet/desktop\n * - Keyboard-aware input handling\n * - Touch-optimized interactions\n */\n\nimport { useState, useCallback, useMemo, useEffect } from 'react';\nimport { useChatStore } from '@/core/store/chatStore';\nimport { useAuthStore } from '@/core/store/authStore';\nimport { useWebSocket } from '@/hooks/useWebSocket';\nimport { useAuth } from '@/hooks/useAuth';\nimport { useMobileNavigation } from '@/hooks/useMobileNavigation';\nimport { useIsMobile, useViewport } from '@/hooks/useViewport';\nimport { cn } from '@/lib/utils';\n\n// Chat components\nimport { ConversationList } from '@/components/chat/ConversationList';\nimport { ChatHeader } from '@/components/chat/ChatHeader';\nimport { MessageList } from '@/components/chat/MessageList';\nimport { MessageInput } from '@/components/chat/MessageInput';\n\n// UI components\nimport { Button } from '@/components/ui/button';\nimport { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar';\nimport { Input } from '@/components/ui/input';\nimport {\n  Dialog,\n  DialogContent,\n  DialogHeader,\n  DialogTitle,\n  DialogDescription,\n} from '@/components/ui/dialog';\nimport {\n  DropdownMenu,\n  DropdownMenuContent,\n  DropdownMenuItem,\n  DropdownMenuSeparator,\n  DropdownMenuTrigger,\n} from '@/components/ui/dropdown-menu';\nimport {\n  MessageSquare,\n  UserPlus,\n  Shield,\n  Trash2,\n  BellOff,\n  Pin,\n  MoreVertical,\n} from 'lucide-react';\n\n// Feature components\nimport { FileUpload } from '@/components/chat/FileUpload';\nimport { Settings } from '@/components/settings';\nimport { IncomingCall, ActiveCall, CallEnded } from '@/components/call';\nimport { Onboarding } from '@/components/Onboarding';\n\n// Types\nimport type { Conversation } from '@/core/types';\nimport { createFileMessageContent, downloadFile } from '@/core/services/fileUpload';\nimport type { UploadResult } from '@/core/services/fileUpload';\n\nexport default function ChatPage() {\n  // Store hooks\n  const {\n    conversations,\n    messages,\n    activeConversationId,\n    setActiveConversation,\n    addConversation,\n    markConversationRead,\n    removeConversation,\n    updateConversation,\n  } = useChatStore();\n  const { user, needsOnboarding, onboardingStep } = useAuthStore();\n  const { logout } = useAuth();\n  const { sendMessage, sendTyping, sendReadReceipt, startCall } = useWebSocket();\n\n  // Viewport and navigation hooks\n  const isMobile = useIsMobile();\n  useViewport(); // Initialize viewport tracking\n  const {\n    navigateToChat,\n    navigateToList,\n    getListPanelClasses,\n    getChatPanelClasses,\n  } = useMobileNavigation({\n    onNavigateToChat: (id) => {\n      setActiveConversation(id);\n    },\n    onNavigateToList: () => {\n      // Optional: clear active conversation on mobile\n      // setActiveConversation(null);\n    },\n  });\n\n  // Local state\n  const [messageInput, setMessageInput] = useState('');\n  const [isNewChatOpen, setIsNewChatOpen] = useState(false);\n  const [newChatUsername, setNewChatUsername] = useState('');\n  const [searchResults, setSearchResults] = useState<Array<{\n    user_id: string;\n    username: string;\n    display_name?: string;\n    avatar_url?: string;\n  }>>([]);\n  const [isSearching, setIsSearching] = useState(false);\n  const [isSettingsOpen, setIsSettingsOpen] = useState(false);\n  const [fileError, setFileError] = useState<string | null>(null);\n  const [downloadingFiles, setDownloadingFiles] = useState<Set<string>>(new Set());\n  const [isSending, setIsSending] = useState(false);\n  const [isDeleteConfirmOpen, setIsDeleteConfirmOpen] = useState(false);\n  const [conversationToDelete, setConversationToDelete] = useState<string | null>(null);\n\n  // Computed values\n  const conversationList = useMemo(() => Object.values(conversations), [conversations]);\n  const activeConversation = activeConversationId ? conversations[activeConversationId] : null;\n  const activeMessages = activeConversationId ? messages[activeConversationId] || [] : [];\n\n  // Mark conversation as read when selected\n  useEffect(() => {\n    if (activeConversationId && (activeConversation?.unreadCount ?? 0) > 0) {\n      markConversationRead(activeConversationId);\n      // Send read receipts for unread messages\n      const unreadMessages = activeMessages.filter(\n        (m) => m.senderId !== user?.id && m.status !== 'read'\n      );\n      unreadMessages.forEach((m) => sendReadReceipt(m.id, activeConversationId));\n    }\n  }, [activeConversationId, activeConversation?.unreadCount, activeMessages, markConversationRead, sendReadReceipt, user?.id]);\n\n  // Search for users as user types\n  useEffect(() => {\n    const searchUsername = newChatUsername.replace(/^@/, '').trim();\n    if (searchUsername.length < 3) {\n      setSearchResults([]);\n      return;\n    }\n\n    setIsSearching(true);\n    const timeoutId = setTimeout(async () => {\n      try {\n        const response = await fetch(`/api/v1/users/search?q=${encodeURIComponent(searchUsername)}&limit=10`, {\n          headers: {\n            Authorization: `Bearer ${useAuthStore.getState().token}`,\n          },\n        });\n\n        if (response.ok) {\n          const results = await response.json();\n          setSearchResults(results || []);\n        }\n      } catch (error) {\n        console.error('Failed to search users:', error);\n      } finally {\n        setIsSearching(false);\n      }\n    }, 300);\n\n    return () => clearTimeout(timeoutId);\n  }, [newChatUsername]);\n\n  // Handle conversation selection\n  const handleSelectConversation = useCallback((id: string) => {\n    if (isMobile) {\n      navigateToChat(id);\n    } else {\n      setActiveConversation(id);\n    }\n  }, [isMobile, navigateToChat, setActiveConversation]);\n\n  // Handle back navigation\n  const handleBack = useCallback(() => {\n    navigateToList();\n  }, [navigateToList]);\n\n  // Handle typing indicator\n  const handleTypingChange = useCallback((isTyping: boolean) => {\n    if (activeConversation) {\n      sendTyping(activeConversation.recipientId, isTyping);\n    }\n  }, [activeConversation, sendTyping]);\n\n  // Handle send message\n  const handleSendMessage = useCallback(async () => {\n    if (!messageInput.trim() || !activeConversation || isSending) return;\n\n    const content = messageInput.trim();\n    setMessageInput('');\n    setIsSending(true);\n\n    try {\n      await sendMessage(activeConversation.recipientId, content);\n    } catch (error) {\n      console.error('Failed to send message:', error);\n      setMessageInput(content); // Restore message on error\n    } finally {\n      setIsSending(false);\n    }\n  }, [messageInput, activeConversation, isSending, sendMessage]);\n\n  // Handle user selection from search\n  const handleSelectUser = useCallback((foundUser: {\n    user_id: string;\n    username: string;\n    display_name?: string;\n    avatar_url?: string;\n  }) => {\n    const conversation: Conversation = {\n      id: foundUser.user_id,\n      recipientId: foundUser.user_id,\n      recipientName: foundUser.display_name || `@${foundUser.username}`,\n      recipientAvatar: foundUser.avatar_url,\n      unreadCount: 0,\n      isOnline: false,\n      isPinned: false,\n      isMuted: false,\n    };\n    addConversation(conversation);\n    setIsNewChatOpen(false);\n    setNewChatUsername('');\n    setSearchResults([]);\n    handleSelectConversation(conversation.id);\n  }, [addConversation, handleSelectConversation]);\n\n  // Handle file upload\n  const handleFileUploadComplete = useCallback(async (result: UploadResult) => {\n    if (!activeConversation) return;\n\n    const content = createFileMessageContent(result.metadata);\n    setIsSending(true);\n    try {\n      await sendMessage(activeConversation.recipientId, content);\n    } finally {\n      setIsSending(false);\n      setFileError(null);\n    }\n  }, [activeConversation, sendMessage]);\n\n  // Handle file download\n  const handleFileDownload = useCallback(async (metadata: import('@/core/types').FileMetadata) => {\n    const mediaId = metadata.mediaId;\n    if (downloadingFiles.has(mediaId)) return;\n\n    setDownloadingFiles(prev => new Set(prev).add(mediaId));\n\n    try {\n      const blob = await downloadFile(metadata);\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = metadata.fileName;\n      document.body.appendChild(a);\n      a.click();\n      document.body.removeChild(a);\n      URL.revokeObjectURL(url);\n    } catch (error) {\n      console.error('Failed to download file:', error);\n      setFileError('Failed to download file');\n    } finally {\n      setDownloadingFiles(prev => {\n        const next = new Set(prev);\n        next.delete(mediaId);\n        return next;\n      });\n    }\n  }, [downloadingFiles]);\n\n  // Handle call\n  const handleCall = useCallback((type: 'audio' | 'video') => {\n    if (!activeConversation) return;\n    startCall(\n      activeConversation.recipientId,\n      activeConversation.recipientName,\n      activeConversation.recipientAvatar,\n      type\n    );\n  }, [activeConversation, startCall]);\n\n  // Handle delete chat\n  const handleDeleteChat = useCallback(() => {\n    if (activeConversationId) {\n      setConversationToDelete(activeConversationId);\n      setIsDeleteConfirmOpen(true);\n    }\n  }, [activeConversationId]);\n\n  // Confirm delete chat\n  const confirmDeleteChat = useCallback(() => {\n    if (conversationToDelete) {\n      removeConversation(conversationToDelete);\n      setIsDeleteConfirmOpen(false);\n      setConversationToDelete(null);\n      if (isMobile) {\n        navigateToList();\n      }\n    }\n  }, [conversationToDelete, removeConversation, isMobile, navigateToList]);\n\n  // Handle toggle mute\n  const handleToggleMute = useCallback(() => {\n    if (activeConversation) {\n      updateConversation(activeConversation.id, { isMuted: !activeConversation.isMuted });\n    }\n  }, [activeConversation, updateConversation]);\n\n  // Handle toggle pin\n  const handleTogglePin = useCallback(() => {\n    if (activeConversation) {\n      updateConversation(activeConversation.id, { isPinned: !activeConversation.isPinned });\n    }\n  }, [activeConversation, updateConversation]);\n\n  // Show onboarding wizard for new users\n  if (needsOnboarding && onboardingStep !== 'complete') {\n    return <Onboarding />;\n  }\n\n  return (\n    <div className=\"h-screen-dynamic flex bg-background overflow-hidden\">\n      {/* ======================= */}\n      {/* CONVERSATION LIST PANEL */}\n      {/* ======================= */}\n      <aside\n        className={cn(\n          // Base styles\n          'flex flex-col bg-background',\n          // Mobile: full screen with animations\n          isMobile && 'mobile-panel',\n          isMobile && getListPanelClasses(),\n          // Desktop: fixed width sidebar\n          !isMobile && 'w-80 lg:w-[360px] xl:w-[400px] border-r border-border flex-shrink-0'\n        )}\n      >\n        <ConversationList\n          conversations={conversationList}\n          activeConversationId={activeConversationId}\n          user={user}\n          onSelectConversation={handleSelectConversation}\n          onNewChat={() => setIsNewChatOpen(true)}\n          onOpenSettings={() => setIsSettingsOpen(true)}\n          onLogout={logout}\n        />\n      </aside>\n\n      {/* ================ */}\n      {/* CHAT VIEW PANEL */}\n      {/* ================ */}\n      <main\n        className={cn(\n          // Base styles\n          'flex-1 flex flex-col bg-background',\n          // Mobile: full screen with animations\n          isMobile && 'mobile-panel',\n          isMobile && getChatPanelClasses(),\n          // Desktop: flex grow\n          !isMobile && 'min-w-0'\n        )}\n      >\n        {activeConversation ? (\n          <>\n            {/* Chat Header with dropdown menu */}\n            <div className=\"relative flex items-center\">\n              <div className=\"flex-1\">\n                <ChatHeader\n                  recipientName={activeConversation.recipientName}\n                  recipientAvatar={activeConversation.recipientAvatar}\n                  isOnline={activeConversation.isOnline}\n                  lastSeen={activeConversation.lastSeen}\n                  onBack={isMobile ? handleBack : undefined}\n                  onVoiceCall={() => handleCall('audio')}\n                  onVideoCall={() => handleCall('video')}\n                  onMoreOptions={undefined}\n                />\n              </div>\n              {/* More Options Dropdown - positioned absolutely on the right */}\n              <div className=\"absolute right-2 top-1/2 -translate-y-1/2 z-10\">\n                <DropdownMenu>\n                  <DropdownMenuTrigger asChild>\n                    <Button variant=\"ghost\" size=\"icon\" className=\"touch-target\">\n                      <MoreVertical className=\"h-5 w-5\" />\n                    </Button>\n                  </DropdownMenuTrigger>\n                  <DropdownMenuContent align=\"end\" className=\"w-48\">\n                    <DropdownMenuItem onClick={handleTogglePin}>\n                      <Pin className=\"h-4 w-4 mr-2\" />\n                      {activeConversation.isPinned ? 'Unpin Chat' : 'Pin Chat'}\n                    </DropdownMenuItem>\n                    <DropdownMenuItem onClick={handleToggleMute}>\n                      <BellOff className=\"h-4 w-4 mr-2\" />\n                      {activeConversation.isMuted ? 'Unmute' : 'Mute Notifications'}\n                    </DropdownMenuItem>\n                    <DropdownMenuSeparator />\n                    <DropdownMenuItem\n                      onClick={handleDeleteChat}\n                      className=\"text-destructive focus:text-destructive\"\n                    >\n                      <Trash2 className=\"h-4 w-4 mr-2\" />\n                      Delete Chat\n                    </DropdownMenuItem>\n                  </DropdownMenuContent>\n                </DropdownMenu>\n              </div>\n            </div>\n\n            {/* Message List */}\n            <MessageList\n              messages={activeMessages}\n              currentUserId={user?.id || ''}\n              onFileDownload={handleFileDownload}\n              downloadingFiles={downloadingFiles}\n            />\n\n            {/* Message Input */}\n            <MessageInput\n              value={messageInput}\n              onChange={setMessageInput}\n              onSubmit={handleSendMessage}\n              onTypingChange={handleTypingChange}\n              isSending={isSending}\n              error={fileError}\n              fileUpload={\n                <FileUpload\n                  onUploadComplete={handleFileUploadComplete}\n                  onError={(error) => {\n                    setFileError(error);\n                    setTimeout(() => setFileError(null), 5000);\n                  }}\n                />\n              }\n            />\n          </>\n        ) : (\n          /* Empty State - No conversation selected */\n          <EmptyState\n            onNewChat={() => setIsNewChatOpen(true)}\n            isMobile={isMobile}\n          />\n        )}\n      </main>\n\n      {/* =============== */}\n      {/* NEW CHAT DIALOG */}\n      {/* =============== */}\n      <Dialog\n        open={isNewChatOpen}\n        onOpenChange={(open) => {\n          setIsNewChatOpen(open);\n          if (!open) {\n            setNewChatUsername('');\n            setSearchResults([]);\n          }\n        }}\n      >\n        <DialogContent className=\"max-w-md\" aria-describedby=\"new-chat-description\">\n          <DialogHeader>\n            <DialogTitle>New Chat</DialogTitle>\n            <DialogDescription id=\"new-chat-description\">\n              Search by username to start a new conversation\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"space-y-4\">\n            <div className=\"relative\">\n              <span className=\"absolute left-3 top-1/2 -translate-y-1/2 text-foreground-muted font-mono\">\n                @\n              </span>\n              <Input\n                type=\"text\"\n                placeholder=\"username\"\n                value={newChatUsername.replace(/^@/, '')}\n                onChange={(e) => setNewChatUsername(e.target.value)}\n                className=\"pl-8 font-mono\"\n                autoFocus\n              />\n            </div>\n\n            {/* Search Results */}\n            {isSearching && (\n              <p className=\"text-sm text-foreground-muted text-center py-2\">Searching...</p>\n            )}\n\n            {!isSearching && searchResults.length > 0 && (\n              <div className=\"border border-border rounded-lg divide-y divide-border max-h-60 overflow-y-auto\">\n                {searchResults.map((result) => (\n                  <button\n                    key={result.user_id}\n                    type=\"button\"\n                    onClick={() => handleSelectUser(result)}\n                    className=\"w-full px-4 py-3 flex items-center gap-3 hover:bg-background-tertiary transition-colors text-left touch-target\"\n                  >\n                    <Avatar className=\"h-10 w-10\">\n                      <AvatarImage src={result.avatar_url} />\n                      <AvatarFallback>\n                        {result.username?.charAt(0).toUpperCase() || '?'}\n                      </AvatarFallback>\n                    </Avatar>\n                    <div>\n                      <p className=\"font-medium\">@{result.username}</p>\n                      {result.display_name && (\n                        <p className=\"text-sm text-foreground-secondary\">{result.display_name}</p>\n                      )}\n                    </div>\n                  </button>\n                ))}\n              </div>\n            )}\n\n            {!isSearching && newChatUsername.replace(/^@/, '').length >= 3 && searchResults.length === 0 && (\n              <p className=\"text-sm text-foreground-muted text-center py-4\">\n                No users found with that username\n              </p>\n            )}\n\n            {newChatUsername.replace(/^@/, '').length > 0 && newChatUsername.replace(/^@/, '').length < 3 && (\n              <p className=\"text-sm text-foreground-muted text-center py-2\">\n                Type at least 3 characters to search\n              </p>\n            )}\n\n            <div className=\"flex justify-end\">\n              <Button type=\"button\" variant=\"outline\" onClick={() => setIsNewChatOpen(false)}>\n                Cancel\n              </Button>\n            </div>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* =============== */}\n      {/* SETTINGS MODAL */}\n      {/* =============== */}\n      <Settings open={isSettingsOpen} onOpenChange={setIsSettingsOpen} />\n\n      {/* ==================== */}\n      {/* DELETE CONFIRMATION */}\n      {/* ==================== */}\n      <Dialog open={isDeleteConfirmOpen} onOpenChange={setIsDeleteConfirmOpen}>\n        <DialogContent className=\"max-w-sm\" aria-describedby=\"delete-chat-description\">\n          <DialogHeader>\n            <DialogTitle>Delete Chat</DialogTitle>\n            <DialogDescription id=\"delete-chat-description\">\n              Are you sure you want to delete this conversation? This action cannot be undone.\n            </DialogDescription>\n          </DialogHeader>\n          <div className=\"flex gap-3 justify-end mt-4\">\n            <Button variant=\"outline\" onClick={() => setIsDeleteConfirmOpen(false)}>\n              Cancel\n            </Button>\n            <Button variant=\"destructive\" onClick={confirmDeleteChat}>\n              Delete\n            </Button>\n          </div>\n        </DialogContent>\n      </Dialog>\n\n      {/* ========= */}\n      {/* CALL UI */}\n      {/* ========= */}\n      <IncomingCall />\n      <ActiveCall />\n      <CallEnded />\n    </div>\n  );\n}\n\n/**\n * Empty state when no conversation is selected\n */\nfunction EmptyState({\n  onNewChat,\n  isMobile,\n}: {\n  onNewChat: () => void;\n  isMobile: boolean;\n}) {\n  // On mobile, this shouldn't really show since we navigate away\n  // But on desktop, show a nice welcome state\n  if (isMobile) {\n    return null;\n  }\n\n  return (\n    <div className=\"flex-1 flex items-center justify-center p-8\">\n      <div className=\"text-center max-w-sm\">\n        <div className=\"w-20 h-20 rounded-full bg-background-tertiary flex items-center justify-center mx-auto mb-4\">\n          <MessageSquare className=\"h-10 w-10 text-foreground-muted\" />\n        </div>\n        <h2 className=\"text-xl font-semibold mb-2\">Welcome to SilentRelay</h2>\n        <p className=\"text-foreground-secondary\">\n          Select a conversation to start messaging, or start a new chat.\n        </p>\n        <div className=\"flex items-center justify-center gap-2 mt-2 text-sm text-foreground-muted\">\n          <Shield className=\"h-4 w-4 text-primary\" />\n          End-to-end encrypted\n        </div>\n        <Button className=\"mt-6\" onClick={onNewChat}>\n          <UserPlus className=\"h-4 w-4 mr-2\" />\n          Start New Chat\n        </Button>\n      </div>\n    </div>\n  );\n}\n","usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\pages\\Landing.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\pages\\legal\\PrivacyPolicy.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\pages\\legal\\SecurityPolicy.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\src\\pages\\legal\\TermsOfService.tsx","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\tailwind.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\vite.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]},{"filePath":"C:\\Users\\JaydenBeard\\Documents\\Messaging-App\\web-new\\vitest.config.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[]}]
